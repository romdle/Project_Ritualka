<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#1E1E1E" />
  <title>студия-гранита.рф — Главная</title>
  <style>
  :root{ --accent:#246e37; --dark:#1E1E1E; --bg:#F6F6F6; --card:#ffffff; --text:#2B2B2B; --maxw:1200px; --header-height:100px; --home-section-gap:48px; }
  html,body{height:100%}
  body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .hero-section{position:relative;background:linear-gradient(135deg,#131313,#000000);overflow:hidden}
  .hero-section::before{content:"";position:absolute;inset:0;background-image:var(--hero-bg-image,none);background-size:cover;background-position:center;opacity:.58;mix-blend-mode:screen;filter:saturate(120%)}
  .hero-section::after{content:"";position:absolute;inset:0;background:rgba(80,110,200,.65);mix-blend-mode:multiply}
  .hero-inner{position:relative;z-index:1;max-width:1440px;margin:0 auto;padding:var(--home-section-gap) 32px;display:flex;flex-wrap:wrap;gap:48px;align-items:center}
  .hero-content{flex:1 1 420px;max-width:640px; margin:0}
  .hero-title{color:#fff;margin:0 0 24px;font-family:Georgia,serif;font-size:48px;font-weight:400;line-height:1.3}
  .hero-text{color:#d1d5db;margin:0 0 32px;font-size:18px;line-height:1.8}
  .hero-actions{display:flex;flex-wrap:wrap;gap:16px}
  .hero-button{display:inline-flex;align-items:center;justify-content:center;background:#246e37;color:#fff;text-decoration:none;border-radius:999px;padding:14px 38px;font-size:16px;font-weight:500;letter-spacing:.2px;transition:background .3s ease,transform .3s ease;min-width:220px;box-shadow:0 12px 24px rgba(36,110,55,.25)}
  .hero-button:hover{background:#1e5a2d;transform:translateY(-2px)}
  .hero-media{flex:1 1 360px;max-width:520px;display:flex;flex-direction:column;gap:16px;align-items:flex-start}
  .hero-media .media{height:360px;width:100%}
  .hero-media-note{color:rgba(255,255,255,.7);font-size:13px}
  .container{max-width:var(--maxw);margin:0 auto;padding:0 24px}
  /* Header */
  header{background:var(--dark);position:relative;z-index:1200;padding-top:env(safe-area-inset-top,0);}
  header::before{content:"";position:absolute;top:calc(-1 * env(safe-area-inset-top,0));left:0;right:0;height:env(safe-area-inset-top,0);background:var(--dark);pointer-events:none}
  .header-inner{height:var(--header-height);display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;align-items:center;gap:12px;color:#fff;text-decoration:none}
  .brand-logo{display:block;height:75px;width:auto}
  nav a{color:#fff;opacity:.9;text-decoration:none;padding:8px 12px;display:inline-block}
  nav a:hover{opacity:1}
  nav a.active{box-shadow:inset 0 -2px 0 0 var(--accent)}
  .header-actions{display:flex;align-items:center;gap:18px}
  .header-phone{display:flex;align-items:center;gap:10px;color:#fff;opacity:.9;text-decoration:none;font-size:16px;transition:opacity .3s ease}
  .header-phone:hover{opacity:1}
  .header-phone svg{width:18px;height:18px;display:block}
  .header-call-button{padding:10px 20px;border:1px solid #246e37;background:transparent;color:#fff;border-radius:8px;font-size:14px;line-height:1.5;font-family:inherit;cursor:pointer;transition:all .3s ease}
  .header-call-button:hover{background:rgba(36,110,55,.1)}
  .menu-button{display:none;align-items:center;justify-content:center;padding:8px 4px;border:none;background:transparent;color:#fff;cursor:pointer;border-radius:0;transition:color .3s ease;min-height:44px;min-width:44px}
  .menu-button:focus-visible{outline:2px solid rgba(255,255,255,.6);outline-offset:3px}
  .menu-button:hover{color:rgba(255,255,255,.85)}
  .menu-button-box{display:flex;flex-direction:column;gap:5px}
  .menu-button-bar{width:30px;height:3px;background:#fff;border-radius:999px;transition:transform .3s ease,opacity .3s ease}
  .menu-button.is-active .menu-button-bar:nth-child(1){transform:translateY(8px) rotate(45deg)}
  .menu-button.is-active .menu-button-bar:nth-child(2){opacity:0}
  .menu-button.is-active .menu-button-bar:nth-child(3){transform:translateY(-8px) rotate(-45deg)}
  .visually-hidden{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  .mobile-menu{position:absolute;top:calc(var(--header-height) + env(safe-area-inset-top,0));left:0;right:0;background:rgba(30,30,30,.96);box-shadow:0 18px 36px rgba(0,0,0,.2);opacity:0;transition:opacity .3s ease,max-height .3s ease;z-index:1300;display:flex;flex-direction:column;pointer-events:none;visibility:hidden;max-height:0;overflow:hidden;border-bottom-left-radius:20px;border-bottom-right-radius:20px;--menu-height:0px}
  .mobile-menu.is-open{opacity:1;pointer-events:auto;visibility:visible;max-height:var(--menu-height)}
  .mobile-menu__inner{padding:20px 24px;display:flex;flex-direction:column;gap:24px;max-width:var(--maxw);margin:0 auto;width:100%}
  .mobile-menu__nav{display:flex;flex-direction:column;gap:12px}
  .mobile-menu__nav a{color:#fff;text-decoration:none;font-size:18px;display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-bottom:1px solid rgba(255,255,255,.08)}
  .mobile-menu__nav a:last-child{border-bottom:none}
  .mobile-menu__nav a svg{width:16px;height:16px;opacity:.6}
  .mobile-menu__contacts{display:flex;flex-direction:column;gap:10px;color:#fff}
  .mobile-menu__contacts a{color:#fff;text-decoration:none;font-size:16px;opacity:.92}
  .mobile-menu__contacts a:hover{opacity:1}
  .mobile-menu__footer-note{color:rgba(255,255,255,.6);font-size:12px;line-height:1.6}
  .mobile-menu__close{position:absolute;top:16px;right:20px;background:rgba(255,255,255,.12);border:none;color:#fff;border-radius:999px;width:42px;height:42px;display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;transition:background .3s ease}
  .mobile-menu__close:hover{background:rgba(255,255,255,.2)}
  .mobile-menu__close:focus-visible{outline:2px solid rgba(255,255,255,.6);outline-offset:2px}
  body.menu-open{overflow:hidden}
  .btn-outline{border:1px solid var(--accent);background:transparent;color:#fff;border-radius:12px;padding:10px 16px;cursor:pointer}
  .btn-outline.dark-text{color:var(--text)}
  .btn-filled{background:var(--dark);color:#fff;border-radius:12px;padding:12px 18px;text-decoration:none;display:inline-block}
  /* Sections */
  .section{padding:24px 0;border-bottom:1px solid #E5E5E5}
  h1{font-size:40px;line-height:1.2;margin:0 0 16px}
  h2{font-size:28px;margin:0 0 16px}
  p{line-height:1.7;margin:0}
  /* Layout */
  .grid{display:grid;gap:24px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .row{display:flex;gap:16px;align-items:center}
  .row-wrap{display:flex;gap:16px;flex-wrap:wrap;align-items:center}
  .mx-auto{margin-left:auto;margin-right:auto}
  .w-24{width:6rem}
  .h-0\.5{height:2px}
  .w-full{width:100%}
  .px-8{padding-left:2rem;padding-right:2rem}
  .py-4{padding-top:1rem;padding-bottom:1rem}
  .bg-\[\#246e37\]{background-color:#246e37}
  .hover\:bg-\[\#1e5a2d\]:hover{background-color:#1e5a2d}
  .text-white{color:#fff}
  .rounded-md{border-radius:0.375rem}
  .transition-all{transition:all .3s ease}
  .flex{display:flex}
  .items-center{align-items:center}
  .justify-center{justify-content:center}
  .gap-2{gap:0.5rem}
  .font-medium{font-weight:500}
  .product-row{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:24px}
  .product-row.product-row--home{margin-top:var(--home-section-gap);margin-bottom:var(--home-section-gap)}
  .product-row--catalog{justify-content:flex-start;grid-template-columns:repeat(4,minmax(0,1fr));gap:32px;justify-items:center}
  .product-tile{background:var(--card);border-radius:18px;display:flex;flex-direction:column;align-items:center;overflow:hidden;box-sizing:border-box;transition:box-shadow .3s ease,transform .3s ease;width:100%;min-width:0;max-width:320px;margin:0 auto;padding:24px 20px 22px;gap:14px;min-height:280px;text-align:center;position:relative;cursor:pointer;outline:none}
  .product-tile:hover{box-shadow:0 16px 32px rgba(0,0,0,.08);transform:translateY(-4px)}
  .product-tile:focus-visible{box-shadow:0 0 0 3px rgba(36,110,55,.35)}
  .product-image-link{width:calc(100% + 40px);aspect-ratio:1/1;border-radius: 0;overflow:hidden;display:flex;align-items:center;justify-content:center;position:relative;margin:-24px -20px 16px;background:#fff;box-shadow:0 18px 42px rgba(17,24,39,.18)}
  .product-image-link img{width:100%;height:100%;object-fit:cover;transition:transform .35s ease;display:block}
  .product-tile:hover .product-image-link img,.product-tile:focus-visible .product-image-link img{transform:scale(1.05)}
  .product-image-placeholder{width:100%;height:100%;position:relative}
  .product-image-placeholder::after{content:"";position:absolute;inset:0;opacity:.2;background-image:repeating-linear-gradient(45deg,#fff,#fff 6px,transparent 6px,transparent 12px)}
  .product-card-content{display:flex;flex-direction:column;gap:8px;align-items:center;width:100%}
  .product-name{color:#2B2B2B;font-family:Georgia,serif;font-size:18px;line-height:1.5;font-weight:400;margin: 0}
  /* Сделать обязательно: базовая стилизация цены с акцентом на значение */
  .product-price{color:#2B2B2B;font-size:17px;font-weight:600;margin:0;display:flex;align-items:baseline;gap:6px;font-family:"Inter","Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif}
  /* Сделать обязательно: стили для префикса и значения цены */
  .product-price-prefix{font-size:.82em;color:#6f6f6f;font-weight:500;font-family:"Inter","Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif}
  .product-price-number{color:#1f1f1f;font-weight:600;letter-spacing:.1px;font-family:"Inter","Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif}
  .product-tile-more{display:inline-flex;align-items:center;justify-content:center;margin-top:auto;font-size:15px;letter-spacing:.2px;color:#fff;text-decoration:none;background:var(--accent);border-radius:18px;padding:12px 26px;min-width:0;transition:background .3s ease,transform .3s ease;border:none;font-family:inherit;cursor:pointer;width:100%;max-width:240px}
  .product-tile-more:hover{background:#1e5a2d;transform:translateY(-2px)}
  .product-tile-more:focus-visible{outline:2px solid rgba(36,110,55,.35);outline-offset:2px}
  .product-detail{display:flex;gap:28px;align-items:flex-start}
  .home-category-block{padding:0 0 32px}
  .home-category-block + .home-category-block{margin-top:0}
  .home-category-header{margin-bottom:32px}
  .product-main-image{width:520px;height:680px;border-radius:18px;overflow:hidden;position:relative;background:linear-gradient(135deg,#d9d9d9,#c8c8c8);border:1px solid rgba(0,0,0,.05)}
  /* Сделать обязательно: курсор для увеличения изображения товара */
  .product-main-image img{width:100%;height:100%;object-fit:cover;cursor:zoom-in}
  .product-main-image::after{content:"";position:absolute;inset:0;opacity:.2;background-image:repeating-linear-gradient(45deg,#fff,#fff 6px,transparent 6px,transparent 12px)}
  .product-main-image.has-image::after{display:none}
  .product-info{display:flex;flex-direction:column;justify-content:space-between;gap:28px;min-height:613px;flex:1;margin-left:0;border-radius:18px;padding:36px 36px 32px;background:rgba(255,255,255,.92);backdrop-filter:blur(6px);box-shadow:0 22px 54px rgba(15,23,42,.12)}
  .product-info-content{flex:1;display:flex;flex-direction:column;gap:24px}
  .product-title{font-family:Georgia,serif;font-size:42px;font-weight:400;line-height:1.3;margin:0}
  .product-description-text{color:#6B6B6B;font-size:16px;line-height:1.8}
  .category-heading{color:#2B2B2B;font-family:Georgia,serif;font-size:28px;font-weight:400;margin:0}
  .product-category-pill{display:inline-block;padding:6px 16px;background:rgba(36,110,55,.1);color:#246e37;border-radius:8px;font-size:13px;letter-spacing:.3px}
  .product-info-content .product-category-pill{align-self:flex-start;margin-bottom:4px}  
  .product-price-label{color:#6B6B6B;margin:0;font-size:14px;letter-spacing:.5px;text-transform:uppercase}
  /* Сделать обязательно: оформление цены на странице товара */
  .product-price-amount{color:#1f1f1f;font-family:"Inter","Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;font-size:34px;font-weight:600;margin-top:8px;display:flex;align-items:baseline;gap:10px;flex-wrap:wrap}
  .product-divider{width:100%;height:1px;background:#E6E6E6;margin:16px 0}
  .description-heading{color:#2B2B2B;margin-bottom:16px;font-family:Georgia,serif;font-size:20px;font-weight:400}
  .back-link{display:flex;align-items:center;gap:8px;color:#6B6B6B;margin-bottom:24px;text-decoration:none;font-size:15px;transition:color .3s ease}
  .back-link:hover{color:#246e37}
  .back-link svg{width:16px;height:16px}
  .callback-button{width:100%;max-width:none;padding:18px 32px;background:#246e37;color:#fff;border-radius:10px;transition:all .3s ease;display:flex;align-items:center;justify-content:center;gap:8px;font-size:16px;font-weight:500;border:none;margin-top:0}
  .callback-button:hover{background:#1e5a2d}
  .callback-button svg{width:18px;height:18px}
  .similar-header{color:#2B2B2B;margin-bottom:8px;font-family:Georgia,serif;font-size:32px;font-weight:400}
  .similar-accent{width:80px;height:2px;background:#246e37;margin:14px 0 24px}
  .product-support-note{color:#6B6B6B;font-size:14px;line-height:1.7;max-width:520px;text-align:center;margin:16px auto 0}
  .catalog-section{padding-top:56x;padding-bottom:64px}
  .catalog-title{color:#2B2B2B;font-family:Georgia,serif;font-size:36px;font-weight:400;line-height:1.4;margin:0 0 12px}
  .page-title{color:#2B2B2B;font-family:Georgia,serif;font-size:36px;font-weight:400;line-height:1.4;margin:0 0 24px}
  .catalog-description{color:#6B6B6B;font-size:16px;line-height:1.7;max-width:640px;margin:0 0 32px}
  .catalog-category-nav{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:36px}
  .catalog-category-button{display:inline-flex;align-items:center;justify-content:center;padding:10px 22px;border-radius:17px;border:1px solid rgba(36,110,55,.4);background:rgba(255,255,255,.9);color:#2B2B2B;font-size:14px;line-height:1.4;text-decoration:none;transition:all .3s ease}
  .catalog-category-button:hover{border-color:#246e37;color:#246e37;box-shadow:0 10px 22px rgba(36,110,55,.15)}
  .catalog-category-button.is-active{background:#246e37;color:#fff;border-color:#246e37;box-shadow:0 12px 28px rgba(36,110,55,.25)}
  @media (max-width:820px){
    .catalog-category-nav{flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:8px;margin-left:-24px;margin-right:-24px;padding-left:24px;padding-right:24px;gap:10px}
    .catalog-category-nav::-webkit-scrollbar{display:none}
    .catalog-category-button{flex:0 0 auto;white-space:nowrap}
  }
  .card{background:var(--card);border-radius:16px;padding:16px}
  .contact-card{padding:24px}
  .contact-info{display:grid;gap:12px;font-size:16px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .contact-info__item{line-height:1.6}
  .contact-info__item strong{display:block;margin-bottom:4px;font-weight:600}
  .contact-info__item a,.contact-info__item span{display:block}
  .contact-map-card{padding:0;border-radius:18px;overflow:hidden}
  .contact-map{position:relative;width:100%;height:390px;background:repeating-conic-gradient(from 0deg,#f1f1f1 0deg 20deg,#e7e7e7 20deg 40deg)}
  .contact-map iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
  @media (max-width:680px){
    .contact-card{padding:20px 18px}
    .contact-map-card{margin:0 -8px;border-radius:18px}
    .contact-map{height:min(70vh,520px)}
    .map-note{padding:12px 18px 0}
  }
  .media{height:180px;border-radius:14px;background:linear-gradient(135deg,#d9d9d9,#c8c8c8);position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center}
  .media::after{content:"";position:absolute;inset:0;opacity:.2;background-image:repeating-linear-gradient(45deg,#fff,#fff 6px,transparent 6px,transparent 12px)}
  .media.has-image::after{display:none}
  .media img{width:100%;height:100%;object-fit:cover;display:block}
  .muted{opacity:.7}
  .materials-section{padding-top:0;padding-bottom:0;margin:calc(var(--home-section-gap) * 1.5) 0 var(--home-section-gap)}
  .materials-header{text-align:center;max-width:720px;margin:0 auto var(--home-section-gap)}
  .materials-title{color:#2B2B2B;margin:0 0 16px;font-family:Georgia,serif;font-size:38px;font-weight:400;line-height:1.3}
  .materials-accent{width:96px;height:2px;background:#246e37;margin:0 auto 24px}
  .materials-description{color:#6B6B6B;margin:0 auto;font-size:16px;line-height:1.7;max-width:640px}
  .materials-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:28px;max-width:1024px;margin:0 auto}
  .material-card{background:var(--card);border-radius:18px;padding:24px;display:flex;flex-direction:column;align-items:center;text-align:center;gap:18px}
  .material-image{width:100%;aspect-ratio:1/1;border-radius:16px;overflow:hidden;position:relative;background:linear-gradient(135deg,#d9d9d9,#c8c8c8);display:flex;align-items:center;justify-content:center;color:#6B6B6B;font-size:12px;letter-spacing:.3em;text-transform:uppercase}
  .material-image img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  .material-title{color:#2B2B2B;margin:0;font-family:Georgia,serif;font-size:18px;font-weight:400}
  .material-text{color:#6B6B6B;margin:0;font-size:14px;line-height:1.6}
  .section-header{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
  .btn-view-all{border:1px solid var(--accent);color:var(--accent);border-radius:10px;padding:8px 14px;font-size:13px;font-weight:500;text-decoration:none;white-space:nowrap;display:inline-flex;align-items:center;gap:6px}
  .btn-view-all:hover{background:rgba(36,110,55,.08)}
  .status-card{background:var(--card);border-radius:16px;padding:20px;font-size:16px}
  .status-card.error{border:1px solid #e57373;background:#fdecea;color:#8a1c1c}
  .product-description{line-height:1.7;font-size:16px}
  .about-section{padding-top:56px;padding-bottom:56px}
  .about-hero{display:grid;gap:24px;align-items:center}
  .about-hero__text{display:flex;flex-direction:column;gap:18px}
  .about-highlights{list-style:none;margin:0;padding:0;display:grid;gap:12px}
  .about-highlights li{display:flex;gap:10px;align-items:flex-start;line-height:1.6;color:#4a4a4a}
  .about-highlights li::before{content:'•';color:#246e37;font-size:20px;line-height:1}
  .about-hero__media .media{height:280px}
  .about-cards{display:grid;gap:20px;margin-top:32px}
  .about-card{background:var(--card);border-radius:18px;padding:24px;display:flex;flex-direction:column;gap:16px}
  .about-card h3{margin:0;font-size:22px;font-family:Georgia,serif;font-weight:400;color:#2B2B2B}
  .about-card p{margin:0;color:#4a4a4a}
  .about-card ul,.about-card ol{margin:0;padding-left:20px;color:#4a4a4a;line-height:1.7}
  .about-steps{counter-reset:step;margin:0;padding-left:0}
  .about-steps li{list-style:none;margin-bottom:10px;padding-left:32px;position:relative}
  .about-steps li::before{counter-increment:step;content:counter(step);position:absolute;left:0;top:2px;width:22px;height:22px;border-radius:999px;background:rgba(36,110,55,.12);color:#246e37;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600}
  .about-steps li:last-child{margin-bottom:0}
  .about-cta{margin-top:32px;text-align:center;display:flex;flex-direction:column;gap:16px}
  .about-cta h3{margin:0;font-size:24px;font-family:Georgia,serif;font-weight:400}
  .about-cta p{margin:0;color:#4a4a4a}
  .about-cta button{align-self:center}
  @media (min-width:860px){
    .about-hero{grid-template-columns:1.05fr 0.95fr}
    .about-cards{grid-template-columns:repeat(2,minmax(0,1fr))}
  }
  @media (max-width:680px){
    .about-hero{grid-template-columns:1fr}
    .about-hero__text{gap:16px}
    .about-highlights li::before{margin-top:6px}
    .about-cta button{width:100%;max-width:260px}
  }
  /* Footer */
  footer{background:var(--dark);color:#fff}
  footer a{color:#fff}
  .footer-top{padding:40px 0}
  .footer-bottom{border-top:1px solid rgba(255,255,255,.1);padding:16px 0;color:rgba(255,255,255,.7);font-size:12px}
  /* Utilities */
  .space-v-16{margin-top:16px}
  .space-v-8{margin-top:8px}
  .link{color:var(--text);text-decoration:none;border-bottom:1px solid transparent}
  .link:hover{border-color:var(--text)}
  /* Responsive */
  .product-carousel{display:flex;align-items:center;gap:16px;position:relative}
  .product-carousel-viewport{flex:1;overflow:hidden}
  .product-carousel-track{--carousel-gap:24px;--carousel-visible:3;display:grid;grid-auto-flow:column;grid-auto-columns:calc((100% - (var(--carousel-visible) - 1)*var(--carousel-gap))/var(--carousel-visible));gap:var(--carousel-gap);transition:transform .4s ease;justify-items:center}
  .product-carousel-track .product-tile{width:100%}
  /* Сделать обязательно: оверлей для увеличенного изображения товара */
  .product-image-overlay{position:fixed;inset:0;background:rgba(17,17,17,.76);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s ease;z-index:1400;padding:32px}
  .product-image-overlay.is-visible{opacity:1;pointer-events:auto}
  .product-image-overlay img{max-width:min(90vw,980px);max-height:90vh;border-radius:18px;box-shadow:0 24px 60px rgba(0,0,0,.35);object-fit:contain;background:#fff}
  .carousel-arrow{background:var(--card);border:1px solid rgba(0,0,0,.08);border-radius:999px;width:44px;height:44px;display:flex;align-items:center;justify-content:center;color:var(--text);cursor:pointer;transition:background .3s ease,transform .3s ease,opacity .3s ease}
  .carousel-arrow svg{width:20px;height:20px}
  .carousel-arrow:hover{background:#fff;transform:translateY(-2px)}
  .carousel-arrow:disabled{opacity:.4;cursor:default;transform:none}
  .product-carousel:not(.is-scrollable) .carousel-arrow{visibility:hidden}
  .product-carousel.is-touch .product-carousel-track{transition:none}
  .product-carousel.is-touch .carousel-arrow{display:none}
  @media (max-width:1200px){
    .product-carousel-track{--carousel-visible:2}
    .product-row--catalog{grid-template-columns:repeat(3,minmax(0,1fr))}
  }
  @media (max-width:960px){
    .grid.cols-3{grid-template-columns:repeat(2,minmax(0,1fr))}
    .product-row{grid-template-columns:repeat(2,minmax(0,1fr))}
  }
  @media (max-width:680px){
    .grid.cols-2,.grid.cols-3{grid-template-columns:1fr}
    h1{font-size:30px}
    .hero-inner{padding:var(--home-section-gap) 24px}
    .hero-button{width:100%;min-width:0}
    .product-detail{flex-direction:column}
    .product-info{min-height:auto;width:100%;padding:24px;box-shadow:none}
    .product-row--catalog{grid-template-columns:repeat(2,minmax(0,1fr))}
    .product-tile{aspect-ratio:auto;min-height:0;padding:20px 16px 20px}
    .product-carousel-track{--carousel-visible:1}
    .product-carousel{gap:0}
    .product-carousel-viewport{overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;margin:0 -24px;padding:0 24px 16px;scroll-padding-left:24px}
    .product-carousel-track{display:flex;gap:16px;width:max-content}
    .product-carousel-track .product-tile{flex:0 0 clamp(260px,82vw,320px);scroll-snap-align:start}
    .product-carousel-track::-webkit-scrollbar{display:none}
  }
  @media (max-width:540px){
    .product-row--catalog{grid-template-columns:1fr}
  }
  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:24px;z-index:1000}
  .modal{background:#fff;border-radius:16px;max-width:520px;width:100%;padding:20px}
  .modal h3{margin:0 0 12px;font-size:22px}
  .form-row{display:flex;flex-direction:column;gap:6px;margin-top:10px}
  .form-row input, .form-row textarea{padding:12px;border-radius:10px;border:1px solid #ddd;font-size:16px}
  .form-actions{display:flex;gap:12px;align-items:center;margin-top:16px}
  .error{color:#b00020;font-size:13px;display:none}
  .success{display:none;padding:10px;border-radius:10px;background:#e7f7ea;border:1px solid #cdebd4;color:#1f6f3b;font-size:14px;margin-top:8px}
  .btn{cursor:pointer;padding:12px 16px;border-radius:12px;border:1px solid var(--accent);background:var(--accent);color:#fff}
  .btn.secondary{background:transparent;color:var(--text)}
  .hidden{display:none !important}
  /* Map placeholder */
  @media (max-width: 1200px) {
      /* Adjust hero content for medium screens */
      .hero-title {
          font-size: 36px;
      }
      .hero-text {
          font-size: 16px;
      }
      .hero-actions .hero-button {
          width: 100%;
          min-width: 0;
      }
  }

  @media (max-width: 960px) {
      /* Adjust hero section and grid for smaller devices */
      .hero-media {
          display: none; /* Hide image on small screens */
      }
      .hero-title {
          font-size: 32px;
      }
      .hero-text {
          font-size: 14px;
      }
      .hero-actions .hero-button {
          width: 100%;
          min-width: 0;
      }
      :root{--header-height:72px;--home-section-gap:40px;}
      .header-inner{
          height: var(--header-height);
          padding: 0 20px;
          gap: 12px;
      }
      .header-actions{gap:12px;}
      .header-phone,
      .header-call-button{
          display: none;
      }
      .header-inner nav{
          display: none;
      }
      .menu-button{
          display:flex;
      }
  }

  @media (max-width: 680px) {
      /* Header adjustments */
      :root {
          --header-height: 68px;
          --home-section-gap: 32px;
      }
      .header-inner {
          height: var(--header-height);
      }
      .brand-logo {
          height: 51px;
      }
      /* Hero section adjustments */
      .hero-title {
          font-size: 28px;
      }
      .hero-text {
          font-size: 14px;
          margin-bottom: 20px;
      }
      .hero-actions .hero-button {
          padding: 12px 24px;
      }

      /* Product grid adjustments */
      .product-row {
          grid-template-columns: 1fr;
      }

      /* Product tile adjustments */
      .product-tile {
          padding: 20px 16px 20px;
      }
      .product-image-link {
          width: calc(100% + 48px);
          margin: -20px -24px 14px;
          border-radius: 16px 16px 0 0;
      }
  }

  @media (max-width: 540px) {
      /* Further reduce font size and padding on very small screens */
      .product-tile {
          padding: 18px 14px 18px;
      }
      .product-image-link {
          width: calc(100% + 36px);
          margin: -18px -18px 12px;
      }
      .hero-title {
          font-size: 24px;
      }
      .hero-text {
          font-size: 12px;
      }
      .hero-actions .hero-button {
          padding: 10px 20px;
      }
  }
  @media (max-width: 960px) {
    /* Обновление сетки для каталога */
    .product-row--catalog {
        grid-template-columns: repeat(1, 1fr);  /* 2 карточки в ряд */
        gap: 24px;  /* Увеличение расстояния между карточками */
    }
  }
    /* Изменения для изображений товаров в каталоге */
  @media (max-width: 960px) {
      .product-image-link img {
          width: 100%; /* Изображение заполняет весь контейнер */
          height: 100%; /* Сохраняем соотношение сторон */
          object-fit: cover;
      }
  }

  /* Изображение товара на странице */

  /* Изображение товара на странице с закруглением сверху */
  @media (max-width: 960px) {
    /* Сделать обязательно: обновлённая мобильная раскладка страницы товара */
    .back-link{margin-bottom:20px;font-size:16px;gap:10px}
    .product-detail{gap:28px}
    .product-main-image{width:100%;height:min(64vh,420px);border-radius:16px;overflow:hidden}
    .product-main-image img{width:100%;height:100%;object-fit:cover}
    .product-info{width:100%;max-width:100%;padding:24px;box-sizing:border-box;margin:0}
    .product-info-content{width:100%;text-align:left;align-items:flex-start;gap:20px}
    .product-title{font-size:25px;line-height:1.1}
    .product-price-amount{font-size:36px}
    .product-price-prefix{font-size:.72em}
    .product-support-note{text-align:left}
    .callback-button{width:100%;max-width:none;margin:24px 0 0;display:flex}
  }
/* Mobile Footer */
  @media (max-width: 680px) {
    footer {
        font-size: 12px;
        color: rgba(255,255,255,0.88);
    }

    footer a {
        font-size: 12px;
        color: rgba(255,255,255,0.88);
    }

    footer .container {
        padding: 16px 20px;
    }

    .footer-bottom {
        padding: 16px 20px;
    }
  }

  @media (min-width: 961px){
    .mobile-menu{display:none}
  }


  </style>
</head>
<body>
  <header>
    <div class="container header-inner">
        <a href="/" class="brand" data-link="home" aria-label="На главную">
            <img src="../static/images/logo2.png" alt="Студия гранита" class="brand-logo" />
        </a>
        <nav class="row" aria-label="Главная навигация">
            <a href="/catalog" data-link="catalog">Каталог</a>
            <a href="/about" data-link="about">О компании</a>
            <a href="/contacts" data-link="contacts">Контакты</a>
        </nav>
        <div class="header-actions">
            <a class="header-phone" href="tel:+74951234567">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M5.5 3h2.8c.4 0 .8.3.9.7l.8 3.1c.1.4 0 .9-.3 1.2l-1.7 1.8c1.4 2.6 3.5 4.7 6.1 6.1l1.8-1.7c.3-.3.8-.4 1.2-.3l3.1.8c.4.1.7.5.7.9v2.8c0 .5-.4.9-.9 1-1 .1-2 .1-3 0-6.4-.6-11.4-5.6-12-12-.1-1-.1-2 0-3 .1-.5.5-.9 1-.9Z" />
                </svg>
                <span>+7 (495) 123-45-67</span>
            </a>
            <button class="header-call-button" type="button" data-action="callback">Заказать звонок</button>
            <button class="menu-button" id="menu-toggle-button" type="button" aria-expanded="false" aria-controls="mobile-menu">
                <span class="visually-hidden">Открыть меню</span>
                <span class="menu-button-box" aria-hidden="true">
                    <span class="menu-button-bar"></span>
                    <span class="menu-button-bar"></span>
                    <span class="menu-button-bar"></span>
                </span>
            </button>
        </div>
    </div>
  </header>

  <!-- Mobile Menu Panel -->
  <div class="mobile-menu" id="mobile-menu" aria-hidden="true">
      <div class="mobile-menu__inner">
          <nav class="mobile-menu__nav" aria-label="Мобильная навигация">
              <a href="/catalog" data-link="catalog">Каталог
              </a>
              <a href="/contacts" data-link="contacts">Контакты
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M9 6l6 6-6 6" />
                  </svg>
              </a>
              <a href="/about" data-link="about">О компании
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M9 6l6 6-6 6" />
                  </svg>
              </a>
          </nav>
          <div class="mobile-menu__contacts">
              <a href="tel:+74951234567">+7 (495) 123-45-67</a>
              <a href="mailto:info@студия-гранита.рф">info@студия-гранита.рф</a>
          </div>
          <p class="mobile-menu__footer-note">Мы на связи ежедневно и готовы помочь с подбором памятника.</p>
      </div>
  </div>

  <main id="app" role="main"></main>

    <!-- Сделать обязательно: оверлей увеличенного изображения товара -->
  <div class="product-image-overlay" data-product-image-overlay hidden>
    <img data-product-image-overlay-image alt="" loading="lazy" />
  </div>

  <footer>
    <div class="container footer-top">
      <div class="grid cols-3">
        <div>
          <div style="font-weight:600">студия-гранита.рф</div>
          <div class="space-v-8" style="opacity:.7;font-size:14px">Изготовление и установка памятников. Работаем с 20XX года.</div>
        </div>
        <div>
          <div style="font-weight:600" class="space-v-8">Навигация</div>
          <div class="row-wrap">
            <a href="/catalog">Каталог</a>
            <a href="/about">О компании</a>
            <a href="/contacts">Контакты</a>
          </div>
        </div>
        <div>
          <div style="font-weight:600" class="space-v-8">Контакты</div>
          <div class="row-wrap">
            <a href="tel:+74951234567">+7 (495) 123-45-67</a>
            <a href="mailto:info@студия-гранита.рф">info@студия-гранита.рф</a>
          </div>
        </div>
      </div>
    </div>
    <div class="footer-bottom">
      <div class="container">© <span id="year"></span> студия-гранита.рф. Все права защищены.</div>
    </div>
  </footer>

  <!-- Unified Callback Modal -->
  <div class="modal-backdrop" id="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal" role="document" aria-labelledby="modal-title">
      <h3 id="modal-title">Заказать звонок</h3>
      <div id="success" class="success">Спасибо! Заявка отправлена. Мы свяжемся с вами в ближайшее время.</div>
      <form id="callback-form" novalidate>
        <div class="form-row">
          <label for="name">Имя*</label>
          <input id="name" name="name" type="text" placeholder="Ваше имя" autocomplete="name" required>
          <div id="err-name" class="error">Введите имя (минимум 2 символа)</div>
        </div>
        <div class="form-row">
          <label for="phone">Телефон*</label>
          <input id="phone" name="phone" type="tel" inputmode="tel" placeholder="+7 (___) ___-__-__" required>
          <div id="err-phone" class="error">Введите корректный телефон в формате +7 (XXX) XXX-XX-XX</div>
        </div>
        <div class="form-row">
          <label for="comment">Комментарий</label>
          <textarea id="comment" name="comment" rows="3" placeholder="Комментарий (опционально)"></textarea>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn" id="submit-btn">Отправить</button>
          <button type="button" class="btn secondary" id="close-btn">Закрыть</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ---------------- State ----------------
  const state = {
    products: [],
    loading: true,
    error: null,
  };
  const activeCarousels = new Set();
  const CATEGORY_TITLES = {
    'Стандартный': 'Стандартные памятники',
    'Семейный': 'Семейные памятники',
    'Эксклюзивный': 'Эксклюзивные памятники',
    'Детский': 'Детские памятники',
  };

  const CATEGORY_ORDER = [
    'Стандартный',
    'Семейный',
    'Эксклюзивный',
    'Детский',
  ];

  const CATEGORY_PRESETS = [
    { slug: 'standartnye', label: 'Стандартные', names: ['Стандартный', 'Стандартные памятники'] },
    { slug: 'semeinye', label: 'Семейные', names: ['Семейный', 'Семейные памятники'] },
    { slug: 'eksklyuzivnye', label: 'Эксклюзивные', names: ['Эксклюзивный', 'Эксклюзивные памятники'] },
    { slug: 'detskie', label: 'Детские', names: ['Детский', 'Детские памятники'] },
  ];

  const DEFAULT_CATALOG_CATEGORY = 'standartnye';

  // ---------------- Helpers ----------------
  function $(sel, root=document){ return root.querySelector(sel); }
  function $all(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }
  
  function setState(partial){
    Object.assign(state, partial);
    render();
  }

  function setActiveNav(base){
    $all('nav a[data-link]').forEach(a=>{
      const link = (a.dataset.link || '').trim();
      const isActive = base ? link === base : link === 'home';
      a.classList.toggle('active', isActive);
    });
  }
  function titleFor(base){
    const map = { '':'Главная', catalog:'Каталог', about:'О компании', contacts:'Контакты', product:'Памятник' };
    return map[base] || 'Главная';
  }
  
  function escapeHtml(value){
    if(value === null || value === undefined) return '';
    return String(value)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function escapeAttribute(value){
    return escapeHtml(value).replace(/\r/g,'').replace(/\n/g,'&#10;');
  }
  function resolveImagePath(path){
    if(!path) return '';
    const raw = String(path).trim();
    if(!raw) return '';
    if(/^https?:\/\//i.test(raw)) return raw;
    if(raw.startsWith('/')) return raw;
    const normalized = raw.replace(/^\.\/?/, '').replace(/^\/+/, '');
    if(normalized.startsWith('static/')){
      return '/' + normalized.replace(/^\/+/, '');
    }
    return '/static/' + normalized;
  }

  function productImage(product){
    const image = product?.img_path ?? product?.image_path ?? '';
    return resolveImagePath(image);
  }

  function displayCategoryName(category){
    const raw = (category ?? '').trim();
    if(!raw) return 'Без категории';
    return CATEGORY_TITLES[raw] || raw;
  }

  function findCategoryPresetByName(name){
    const normalized = (name ?? '').trim().toLowerCase();
    if(!normalized) return null;
    return CATEGORY_PRESETS.find(preset => preset.names.some(candidate => candidate.toLowerCase() === normalized)) || null;
  }

  function findCategoryPresetBySlug(slug){
    const normalized = (slug ?? '').trim().toLowerCase();
    if(!normalized) return null;
    return CATEGORY_PRESETS.find(preset => preset.slug === normalized) || null;
  }

  function categorySlug(category){
    const preset = findCategoryPresetByName(category);
    if(preset) return preset.slug;
    const label = displayCategoryName(category);
    const normalized = label.trim().toLowerCase();
    if(!normalized) return 'uncategorized';
    return normalized
      .replace(/[^\p{Letter}\p{Number}]+/gu, '-')
      .replace(/^-+|-+$/g, '') || 'uncategorized';
  }

  function categoryLabel(category){
    const preset = findCategoryPresetByName(category);
    if(preset) return preset.label;
    return displayCategoryName(category);
  }

  function productLink(id){
    return '/product/' + encodeURIComponent(String(id));
  }

  /* Сделать обязательно: подготовка частей цены для отображения */
  function priceParts(product){
    const fallback = { prefix: '', value: 'по запросу', safeValue: escapeHtml('по запросу') };
    if(!product) return fallback;
    const value = product.price;
    if(value === null || value === undefined || value === ''){
      return fallback;
    }
    const num = Number(value);
    if(Number.isFinite(num)){
      const display = new Intl.NumberFormat('ru-RU').format(num) + ' ₽';
      return { prefix: 'от', value: display, safeValue: escapeHtml(display) };
    }
    const textValue = String(value).trim();
    if(!textValue){
      return fallback;
    }
    if(/^по запросу$/i.test(textValue)){
      return fallback;
    }
    const display = textValue;
    return { prefix: 'от', value: display, safeValue: escapeHtml(display) };
  }

  function priceText(product){
    const { prefix, value } = priceParts(product);
    return prefix ? `${prefix} ${value}` : value;
  }

  function priceValue(product){
    return priceParts(product).value;
  }

  function formatTextBlock(text){
    if(text === null || text === undefined) return '';
    return escapeHtml(String(text)).replace(/\r?\n/g,'<br>');
  }

  function snippet(text, limit=90){
    if(text === null || text === undefined) return '';
    const str = String(text).trim();
    if(str.length <= limit) return str;
    return str.slice(0, limit - 1) + '…';
  }

  function getProductById(id){
    return state.products.find(p => String(p.id) === String(id));
  }

  function similarList(product){
    if(!product) return [];
    const currentId = String(product.id);
    const targetCategory = (product.category ?? '').trim().toLowerCase();
    const sameCategory = state.products
      .filter(p => String(p.id) !== currentId && (p.category ?? '').trim().toLowerCase() === targetCategory);
    if(sameCategory.length) return sameCategory;
    const standardCategory = state.products
      .filter(p => String(p.id) !== currentId && (p.category ?? '').trim().toLowerCase() === 'стандартный');
    if(standardCategory.length) return standardCategory;
    return state.products.filter(p => String(p.id) !== currentId);
  }

  function media(height, imageUrl='', altText=''){
    const style = height ? ` style="height:${height}px"` : '';
    if(imageUrl){
      const safeUrl = escapeAttribute(imageUrl);
      const safeAlt = escapeHtml(altText || 'Изображение памятника');
      return `<div class="media has-image"${style}><img src="${safeUrl}" alt="${safeAlt}" loading="lazy"></div>`;
    }
    return `<div class="media"${style}></div>`;
  }

  function normalizeProduct(raw){
    if(!raw || typeof raw !== 'object') return {};
    return {
      id: raw.id,
      name: raw.name ?? raw.title ?? '',
      price: raw.price,
      description: raw.description ?? '',
      img_path: raw.img_path ?? raw.image_path ?? '',
      category: raw.category ?? '',
    };
  }

  function renderStatus(message, isError=false){
    const safe = escapeHtml(message);
    const extra = isError ? ' error' : '';
    return `<div class="status-card${extra}">${safe}</div>`;
  }

  function orderedCategories(){
    const groups = new Map();
    state.products.forEach(product => {
      const raw = (product.category ?? '').trim();
      const key = raw || 'Без категории';
      if(!groups.has(key)){
        groups.set(key, []);
      }
      groups.get(key).push(product);
    });
    const entries = Array.from(groups.entries()).map(([key, items]) => ({
      key,
      display: displayCategoryName(key),
      slug: categorySlug(key),
      items,
    }));
    const index = (name) => {
      const raw = (name ?? '').trim();
      const idx = CATEGORY_ORDER.indexOf(raw);
      return idx === -1 ? CATEGORY_ORDER.length : idx;
    };
    entries.sort((a, b) => {
      const orderDiff = index(a.key) - index(b.key);
      if(orderDiff !== 0) return orderDiff;
      return a.display.localeCompare(b.display, 'ru');
    });
    return entries;
  }

  function catalogCategoryGroups(){
    const groups = new Map();
    state.products.forEach(product => {
      const slug = categorySlug(product.category);
      const label = categoryLabel(product.category);
      if(!groups.has(slug)){
        groups.set(slug, { slug, label, items: [], sources: new Set() });
      }
      const group = groups.get(slug);
      group.items.push(product);
      const source = (product.category ?? '').trim();
      if(source){
        group.sources.add(source);
      }
    });
    const list = Array.from(groups.values());
    const presetIndex = (slug) => {
      const preset = findCategoryPresetBySlug(slug);
      if(!preset) return -1;
      return CATEGORY_PRESETS.indexOf(preset);
    };
    const fallbackIndex = (group) => {
      const [firstSource] = group.sources ? Array.from(group.sources) : [];
      const fallback = (group.items[0]?.category ?? firstSource ?? '').trim();
      const idx = CATEGORY_ORDER.indexOf(fallback);
      if(idx !== -1) return idx;
      return CATEGORY_ORDER.length;
    };
    list.sort((a, b) => {
      const aPreset = presetIndex(a.slug);
      const bPreset = presetIndex(b.slug);
      const aScore = aPreset === -1 ? CATEGORY_PRESETS.length : aPreset;
      const bScore = bPreset === -1 ? CATEGORY_PRESETS.length : bPreset;
      if(aScore !== bScore) return aScore - bScore;
      if(aPreset !== bPreset) return aPreset - bPreset;
      const fallbackDiff = fallbackIndex(a) - fallbackIndex(b);
      if(fallbackDiff !== 0) return fallbackDiff;
      return a.label.localeCompare(b.label, 'ru');
    });
    return list;
  }

  function renderCatalogCategoryNav(categories, activeSlug){
    if(!categories || !categories.length) return '';
    const active = (activeSlug ?? '').trim().toLowerCase();
    const items = categories.map(category => {
      const isActive = category.slug === active;
      const href = '/catalog?category=' + encodeURIComponent(category.slug);
      const label = escapeHtml(category.label);
      const ariaCurrent = isActive ? ' aria-current="page"' : '';
      const classes = 'catalog-category-button' + (isActive ? ' is-active' : '');
      return `<a class="${classes}" href="${escapeAttribute(href)}"${ariaCurrent}>${label}</a>`;
    }).join('');
    return `<nav class="catalog-category-nav" aria-label="Категории памятников">${items}</nav>`;
  }

  function resolveCatalogActive(categories, query){
    if(!categories || !categories.length){
      return { slug: '', group: null };
    }
    const raw = (query?.get?.('category') ?? '').trim().toLowerCase();
    if(raw){
      const matched = categories.find(category => category.slug === raw);
      if(matched){
        return { slug: matched.slug, group: matched };
      }
      const preset = findCategoryPresetBySlug(raw);
      if(preset){
        const presetGroup = categories.find(category => category.slug === preset.slug);
        if(presetGroup){
          return { slug: presetGroup.slug, group: presetGroup };
        }
      }
    }
    const defaultGroup = categories.find(category => category.slug === DEFAULT_CATALOG_CATEGORY);
    if(defaultGroup){
      return { slug: defaultGroup.slug, group: defaultGroup };
    }
    const fallback = categories[0];
    return { slug: fallback?.slug ?? '', group: fallback ?? null };
  }

  function renderHomeCategories(){
    if(state.loading){
      return renderStatus('Загружаем каталог...');
    }
    if(state.error){
      return renderStatus(state.error, true);
    }
    const categories = orderedCategories();
    if(!categories.length){
      return renderStatus('Каталог пока пуст. Возвращайтесь позже.');
    }
    return categories.map(category => {
      const heading = escapeHtml(category.display);
      const slug = category.slug || categorySlug(category.key);
      const href = '/catalog?category=' + encodeURIComponent(slug);
      const aria = escapeAttribute(`Перейти в каталог категории ${category.display}`);
    const cards = category.items.length
      ? productCarousel(category.items, {
          label: `Категория ${category.display}`,
          prev: `Предыдущие памятники категории ${category.display}`,
          next: `Следующие памятники категории ${category.display}`,
        })
      : `<div class="status-card" style="width:100%;">В этой категории пока нет товаров.</div>`;
    return `
          <section class="home-category-block">
            <div class="section-header home-category-header">
              <h2 class="category-heading">${heading}</h2>
              <a class="btn-view-all" href="${escapeAttribute(href)}" aria-label="${aria}">Каталог</a>
            </div>
            ${cards}
          </section>
        `;
    }).join('');
  }
  function productCard(product){
    if(!product) return '';
      const id = String(product.id);
      const nameRaw = product.name || product.title || `Памятник ${id}`;
      const name = escapeHtml(nameRaw);
      const image = productImage(product);
      const dataId = escapeAttribute(id);
      const link = productLink(id);
      const aria = escapeAttribute(`Подробнее о ${nameRaw}`);
      const safeImage = escapeAttribute(image);
      const safeAlt = escapeHtml(nameRaw);
      /* Сделать обязательно: сборка цены для карточки товара */
      const priceInfo = priceParts(product);
      const pricePrefix = priceInfo.prefix ? escapeHtml(priceInfo.prefix) : '';
      const priceMarkup = priceInfo.prefix
        ? `<div class="product-price"><span class="product-price-prefix">${pricePrefix}</span><span class="product-price-number">${priceInfo.safeValue}</span></div>`
        : `<div class="product-price">${priceInfo.safeValue}</div>`;
    const imageContent = image
    ? `<img src="${safeImage}" alt="${safeAlt}" loading="lazy">`
    : `<div class="product-image-placeholder" aria-hidden="true"></div>`;
    const safeLink = escapeAttribute(link);
    const prefill = escapeAttribute(nameRaw);
    return `
      <article class="product-tile" data-testid="product-card-${dataId}" data-link="${safeLink}" tabindex="0" role="link" aria-label="${aria}">
        <div class="product-image-link${image ? ' has-image' : ''}">
          ${imageContent}
        </div>
        <div class="product-card-content">
          <div class="product-name">${name}</div>
          ${priceMarkup}
        </div>
        <button class="product-tile-more" type="button" data-action="callback" data-prefill="${prefill}">Заказать</button>
      </article>
    `;
  }

  let carouselSequence = 0;

  function productCarousel(items, labels={}){
    if(!items || !items.length) return '';
    const id = `carousel-${++carouselSequence}`;
    const prevLabel = escapeAttribute(labels.prev || 'Предыдущие товары');
    const nextLabel = escapeAttribute(labels.next || 'Следующие товары');
    const regionLabel = escapeAttribute(labels.label || 'Лента товаров');
    return `
      <div class="product-carousel" data-carousel aria-label="${regionLabel}" role="region" data-carousel-id="${id}">
        <button class="carousel-arrow" type="button" data-carousel-prev aria-label="${prevLabel}">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M14.5 5.5 9 11l5.5 5.5" />
          </svg>
        </button>
          <div class="product-carousel-viewport" data-carousel-viewport>
            <div class="product-carousel-track" data-carousel-track>
            ${items.map(productCard).join('')}
          </div>
        </div>
        <button class="carousel-arrow" type="button" data-carousel-next aria-label="${nextLabel}">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="m9.5 5.5 5.5 5.5-5.5 5.5" />
          </svg>
        </button>
      </div>
    `;
  }

  function setupCarousels(){
    activeCarousels.clear();
    $all('[data-carousel]').forEach(carousel => {
      const instance = initializeCarousel(carousel);
      if(instance){
        activeCarousels.add(instance);
        instance.refresh();
      }
    });
  }

  function initializeCarousel(carousel){
    const viewport = carousel.querySelector('[data-carousel-viewport]');
    const track = carousel.querySelector('[data-carousel-track]');
    if(!viewport || !track) return null;
    const prevBtn = carousel.querySelector('[data-carousel-prev]');
    const nextBtn = carousel.querySelector('[data-carousel-next]');
    let index = 0;
    const touchMedia = window.matchMedia('(max-width: 680px)');
    let touchMode = touchMedia.matches;

    function syncTouchMode(){
      const next = touchMedia.matches;
      if(next !== touchMode){
        touchMode = next;
      }
      carousel.classList.toggle('is-touch', touchMode);
      if(touchMode){
        track.style.transform = '';
        viewport.scrollLeft = 0;
        index = 0;
      }
    }

    function measureOverflow(){
      return track.scrollWidth - viewport.clientWidth > 1;
    }
    
    function totalItems(){
      return track.children.length;
    }

    function gapSize(){
      const styles = getComputedStyle(track);
      const value = styles.columnGap || styles.gap || '0';
      const parsed = parseFloat(value);
      return Number.isFinite(parsed) ? parsed : 0;
    }

    function computeVisible(){
      const card = track.querySelector('.product-tile');
      if(!card) return 1;
      const cardWidth = card.getBoundingClientRect().width;
      if(cardWidth <= 0) return 1;
      const viewportWidth = viewport.getBoundingClientRect().width;
      const gap = gapSize();
      const approx = Math.floor((viewportWidth + gap) / (cardWidth + gap));
      return Math.max(1, Math.min(totalItems(), approx || 1));
    }

    function updateButtons(maxIndex, hasOverflow){
      const hideButtons = touchMode;
      const effectiveOverflow = hideButtons ? measureOverflow() : hasOverflow;
      carousel.classList.toggle('is-scrollable', !hideButtons && effectiveOverflow);
      if(prevBtn){
        const disabled = hideButtons || index <= 0;
        prevBtn.disabled = disabled;
        prevBtn.setAttribute('aria-disabled', disabled ? 'true' : 'false');
        prevBtn.style.visibility = (!hideButtons && effectiveOverflow) ? 'visible' : 'hidden';
      }
      if(nextBtn){
        const disabled = hideButtons || index >= maxIndex;
        nextBtn.disabled = disabled;
        nextBtn.setAttribute('aria-disabled', disabled ? 'true' : 'false');
        nextBtn.style.visibility = (!hideButtons && effectiveOverflow) ? 'visible' : 'hidden';
      }
    }

    function applyTransform(){
      if(touchMode){
        track.style.transform = '';
        return;
      }
      const card = track.querySelector('.product-tile');
      if(!card){
        track.style.transform = 'translateX(0)';
        return;
      }
      const offset = index * (card.getBoundingClientRect().width + gapSize());
      track.style.transform = `translateX(${-offset}px)`;
    }

    function slideTo(target){
      syncTouchMode();
      if(touchMode){
        updateButtons(0, measureOverflow());
        return;
      }
      const visibleCount = computeVisible();
      const maxIndex = Math.max(0, totalItems() - visibleCount);
      index = Math.max(0, Math.min(target, maxIndex));
      applyTransform();
      updateButtons(maxIndex, totalItems() > visibleCount);
    }

    function slideBy(delta){
      slideTo(index + delta);
    }

    if(prevBtn){
      prevBtn.addEventListener('click', ()=> slideBy(-1));
    }
    if(nextBtn){
      nextBtn.addEventListener('click', ()=> slideBy(1));
    }

    const handleMediaChange = () => {
      syncTouchMode();
      slideTo(index);
    };
    if(typeof touchMedia.addEventListener === 'function'){
      touchMedia.addEventListener('change', handleMediaChange);
    }else if(typeof touchMedia.addListener === 'function'){
      touchMedia.addListener(handleMediaChange);
    }

    syncTouchMode();
    slideTo(0);

    return {
      refresh(){ slideTo(index); },
      handleResize(){ slideTo(index); },
    };
  }

  window.addEventListener('resize', ()=>{
    activeCarousels.forEach(instance => {
      if(instance && typeof instance.handleResize === 'function'){
        instance.handleResize();
      }
    });
  });
  // Toggle mobile menu visibility
  const menuToggleButton = document.getElementById('menu-toggle-button');
  const mobileMenu = document.getElementById('mobile-menu');
  if(menuToggleButton && mobileMenu){
    const closeButtons = $all('[data-mobile-menu-close]', mobileMenu);
    const menuLinks = $all('a[href]', mobileMenu);
    const overlayClickHandler = (event) => {
      if(event.target === mobileMenu){
        setMobileMenu(false);
      }
    };

        function computeMenuHeight(){
      const inner = mobileMenu.querySelector('.mobile-menu__inner');
      return inner ? inner.scrollHeight : 0;
    }

    function applyMenuHeight(){
      if(mobileMenu.classList.contains('is-open')){
        const height = computeMenuHeight();
        if(height){
          mobileMenu.style.setProperty('--menu-height', `${height}px`);
        }
      }
    }

    function setMobileMenu(open){
      const shouldOpen = open !== undefined ? open : !mobileMenu.classList.contains('is-open');
      if(shouldOpen){
        const height = computeMenuHeight();
        if(height){
          mobileMenu.style.setProperty('--menu-height', `${height}px`);
        }
      }
      mobileMenu.classList.toggle('is-open', shouldOpen);
      document.body.classList.toggle('menu-open', shouldOpen);
      menuToggleButton.classList.toggle('is-active', shouldOpen);
      menuToggleButton.setAttribute('aria-expanded', shouldOpen ? 'true' : 'false');
      mobileMenu.setAttribute('aria-hidden', shouldOpen ? 'false' : 'true');
      if(shouldOpen){
        requestAnimationFrame(applyMenuHeight);
      }
    }

    menuToggleButton.addEventListener('click', () => setMobileMenu());
    closeButtons.forEach(button => button.addEventListener('click', () => setMobileMenu(false)));
    menuLinks.forEach(link => link.addEventListener('click', () => setMobileMenu(false)));
    mobileMenu.addEventListener('click', overlayClickHandler);
    document.addEventListener('keydown', (event) => {
      if(event.key === 'Escape' && mobileMenu.classList.contains('is-open')){
        setMobileMenu(false);
      }
    });
    window.addEventListener('resize', applyMenuHeight);
  } 

  // ---------------- Views ----------------
  function viewHome(){
    return `
      <section class="hero-section" style="--hero-bg-image:url('../static/images/main.png');">
        <!-- Замените URL_ДЛЯ_ФОНА на ссылку на нужное фоновое изображение -->
        <div class="hero-inner">
          <div class="hero-content">
            <h1 class="hero-title">Мы создаём памятники с заботой и уважением</h1>
            <p class="hero-text">Мы сопровождаем семьи на каждом этапе: от выбора материала до установки. Работаем с натуральным гранитом, мрамором и габбро‑диабазом. Бережно относимся к традициям и деталям, чтобы память о близких сохраняла достоинство долгие годы.</p>
            <div class="hero-actions">
              <a class="hero-button" id="cta-home" href="/catalog">Перейти в каталог</a>
            </div>
          </div>
          </div>
        </div>
      </section>
      <section class="materials-section">
        <div class="container">
          <div class="materials-header">
            <h2 class="materials-title">Материалы, из которых мы работаем</h2>
            <div class="materials-accent"></div>
            <p class="materials-description">Используем только натуральный камень высочайшего качества, проверенный временем.</p>
          </div>
          <div class="materials-grid">
            <!-- Замените #материал1, #материал2 и #материал3 на реальные пути к изображениям материалов -->
            ${[
              ["Карельский Габбро-Диабаз","Самый распространенный камень для памятников","../static//images/material_black.png"],
              ["Премиальные виды гранита","Блю Перл(Норвегия), Шокша(Карелия), Хибинит","../static//images/material_blue.png"],
              ["Разнообразные виды камня","Большая палитра цветов для Ваших памятников. Дымовский, Возрождение, Ала-Носкуа, Игл Рэд, Балтик Грин и многие другие","../static//images/material_brown.png"],
            ].map(([name,note,marker])=>`
              <article class="material-card">
                <div class="material-image">
                  <img src="${escapeAttribute(marker)}" alt="${escapeAttribute(name)}" loading="lazy" onerror="this.style.display='none'">
                </div>
                <div class="material-title">${name}</div>
                <p class="material-text">${note}</p>
              </article>
            `).join('')}
          </div>
        </div>
      </section>
      <div class="container" style="text-align:center;padding:32px 0 12px;">
        <div style="font-family: Georgia, serif; font-size: 38px; font-weight: 400; line-height: 1.3;">Наши работы</div>
        <div class="w-24 h-0.5 bg-[#246e37] mx-auto" style="margin-top:12px;"></div>
      </div>
      <section class="section" id="catalog-preview">
        <div class="container">
          ${renderHomeCategories()}
        </div>
      </section>
    `;
  }


  function viewCatalog(context={}){
    const query = context?.query instanceof URLSearchParams ? context.query : new URLSearchParams();
    let nav = '';
    let body = '';
    if(state.loading){
      body = renderStatus('Загружаем каталог...');
    }else if(state.error){
      body = renderStatus(state.error, true);
    }else if(!state.products.length){
      body = renderStatus('Каталог пока пуст. Возвращайтесь позже.');
    }else{
      const categories = catalogCategoryGroups();
      if(!categories.length){
        body = renderStatus('Каталог пока пуст. Возвращайтесь позже.');
      }else{
        const { slug, group } = resolveCatalogActive(categories, query);
        nav = renderCatalogCategoryNav(categories, slug);
        const items = group?.items ?? [];
        body = items.length
          ? `<div class="product-row product-row--catalog">${items.map(productCard).join('')}</div>`
          : `<div class="status-card">В этой категории пока нет товаров.</div>`;
      }
    }
    return `
      <section class="section catalog-section">
        <div class="container">
          <h1 class="catalog-title">Каталог памятников</h1>
          <p class="catalog-description">Мы создаём памятники с заботой и уважением к памяти ваших близких. Каждое изделие выполнено из качественных материалов и отражает вечную память.</p>
          ${nav}
          ${body}
        </div>
      </section>
    `;
  }

  function viewAbout(){
    return `
      <section class="section about-section">
        <div class="container">
          <h1 class="page-title">О компании</h1>
          <div class="about-hero">
            <div class="about-hero__text">
              <p>«Студия гранита» — это команда мастеров, которая бережно помогает увековечить память о близких. Мы работаем с каждым проектом индивидуально: уточняем пожелания, предлагаем варианты оформления и сопровождаем семью на всех этапах.</p>
              <ul class="about-highlights">
                <li>Собственное производство и строгий контроль качества.</li>
                <li>Каталог проверенных материалов, подходящих для нашего климата.</li>
                <li>Установка памятника «под ключ» и помощь в благоустройстве участка.</li>
              </ul>
            </div>
            <div class="about-hero__media">${media(280)}</div>
          </div>
          <div class="about-cards">
            <article class="about-card">
              <h3>Почему нам доверяют</h3>
              <p>Мы уделяем внимание каждой детали: создаём эскиз вместе с семьёй, подбираем гармоничную гравировку и аккуратно монтируем конструкцию на месте.</p>
              <ul>
                <li>Чёткие сроки изготовления и установки.</li>
                <li>Гарантия на камень и выполненные работы.</li>
                <li>Фотоотчёты на каждом этапе производства.</li>
              </ul>
            </article>
            <article class="about-card">
              <h3>Этапы нашей работы</h3>
              <ol class="about-steps">
                <li>Консультация и подбор оптимального решения.</li>
                <li>Создание дизайна и согласование всех деталей.</li>
                <li>Производство памятника и художественных элементов.</li>
                <li>Монтаж и благоустройство на кладбище.</li>
              </ol>
            </article>
          </div>
          <div class="about-cta card contact-card">
            <h3>Всегда на связи</h3>
            <p>Свяжитесь с нами удобным способом — мы подскажем, как подготовиться к встрече, и ответим на любые вопросы.</p>
            <button class="btn-outline dark-text" style="border-color:var(--accent)" data-action="callback">Заказать звонок</button>
          </div>
        </div>
      </section>
    `;
  }

  function viewContacts(){
    return `
      <section class="section">
        <div class="container">
          <h1 class="page-title">Контакты</h1>
          <div class="space-v-16"></div>
          <div class="card contact-card">
            <div class="contact-info">
              <div class="contact-info__item"><strong>Телефон</strong><a class="link" href="tel:+79697119311">+7 (969) 711-93-11</a></div>
              <div class="contact-info__item"><strong>E‑mail</strong><a class="link" href="mailto:pasha-litvinov@ya.ru">pasha-litvinov@ya.ru</a></div>
              <div class="contact-info__item"><strong>Адрес</strong><span>г. Псков, улица Некрасова, 33</span></div>
              <div class="contact-info__item"><strong>Часы работы</strong><span>Пн–Сб 9:00–20:00</span></div>
            </div>
            <div class="space-v-16"></div>
            <button class="btn-outline dark-text" style="color:#246e37, border-color:var(--accent)" data-action="callback">Заказать звонок</button>
          </div>
          <div class="space-v-16"></div>
          <div class="card contact-map-card">
            <div class="contact-map" id="ymap" aria-label="Карта (плейсхолдер)">
              <iframe src="https://yandex.ru/map-widget/v1/?um=constructor%3Abb7992e8cefbe38498df6835759ee00aa210782ea5a5783b2af9b1b30884da90&amp;source=constructor" width="100%" height="100%" frameborder="0" allowfullscreen></iframe>
            </div>
            <div class="map-note">Мы находимся на территории «Примерного мемориального комплекса». Перед визитом позвоните нам для уточнения деталей.</div>
          </div>
        </div>
      </section>
    `;
  }
  function viewProduct(id){
    if(state.loading){
      return `
        <section class="section">
          <div class="container">
            ${renderStatus('Загружаем данные о товаре...')}
          </div>
        </section>
      `;
    }
    if(state.error){
      return `
        <section class="section">
          <div class="container">
            ${renderStatus(state.error, true)}
          </div>
        </section>
      `;
    }
    const product = getProductById(id);
    if(!product){
      return `
        <section class="section">
          <div class="container">
            ${renderStatus('Товар не найден или был удалён.')}
            <div class="space-v-16"></div>
            <a class="btn-view-all" href="/catalog">Вернуться в каталог</a>
          </div>
        </section>
      `;
    }
    const idValue = String(product.id);
    const nameRaw = product.name || product.title || `Памятник ${idValue}`;
    const name = escapeHtml(nameRaw);
    const categoryName = escapeHtml(displayCategoryName(product.category));
    /* Сделать обязательно: подготовка цены для страницы товара */
    const detailPriceInfo = priceParts(product);
    const detailPricePrefix = detailPriceInfo.prefix ? `<span class="product-price-prefix">${escapeHtml(detailPriceInfo.prefix)}</span>` : '';
    const detailPriceValue = `<span class="product-price-number">${detailPriceInfo.safeValue}</span>`;
    const detailPriceMarkup = detailPriceInfo.prefix ? detailPricePrefix + detailPriceValue : detailPriceValue;
    const description = product.description
      ? `<div class="product-description-text">${formatTextBlock(product.description)}</div>`
      : `<div class="product-description-text" style="opacity:.7;">Описание появится позже.</div>`;
    const image = productImage(product);
    const safeImage = escapeAttribute(image);
    const safeAlt = escapeHtml(nameRaw);
    const callbackPrefill = escapeAttribute(`Интересует ${nameRaw}`);
    const similarItems = similarList(product);
    const similarCards = similarItems.length
      ? productCarousel(similarItems, {
          label: 'Похожие памятники',
          prev: 'Предыдущие похожие памятники',
          next: 'Следующие похожие памятники',
        })
      : `<div class="status-card" style="width:100%;">Пока нет похожих памятников.</div>`;
    return `
      <section class="section">
        <div class="container">
            <a class="back-link" href="/catalog">
            <svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M11.707 4.293a1 1 0 0 1 0 1.414L8.414 9H17a1 1 0 1 1 0 2H8.414l3.293 3.293a1 1 0 0 1-1.414 1.414l-5-5a1 1 0 0 1 0-1.414l5-5a1 1 0 0 1 1.414 0Z"/></svg>
            <span>Назад к каталогу</span>
          </a>
          <div class="product-detail">
            <div class="product-main-image${image ? ' has-image' : ''}">
              ${image ? `<img src="${safeImage}" alt="${safeAlt}" loading="lazy">` : ''}
            </div>
              <div class="product-info">
              <div class="product-info-content">
                <span class="product-category-pill">${categoryName}</span>
                <h2 class="product-title">${name}</h2>
                <div class="product-price-amount">${detailPriceMarkup}</div>
                <div class="product-divider"></div>
                <div>
                  <div class="description-heading">Описание</div>
                  ${description}
                </div>
              </div>
              <button class="callback-button" data-action="callback" data-prefill="${callbackPrefill}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M5.5 3.75h4l1.5 3.75-2.25 1.5a11 11 0 0 0 5.75 5.75l1.5-2.25 3.75 1.5v4a1.5 1.5 0 0 1-1.625 1.5 17.5 17.5 0 0 1-15.125-15.125A1.5 1.5 0 0 1 5.5 3.75Z" />
                </svg>
                <span>Заказать звонок</span>
              </button>
              <div class="product-support-note">Наши специалисты помогут подобрать оптимальный вариант памятника, проконсультируют по материалам и срокам изготовления. Звоните или оставьте заявку на обратный звонок.</div>
            </div>
          </div>
        </div>
        <div class="container" style="margin-top:56px;">
          <div class="similar-header">Похожие памятники</div>
          <div class="similar-accent"></div>
          ${similarCards}
        </div>
      </section>
    `;
  }



  // ---------------- Router ----------------
  function normalizePath(path){
    if(path === null || path === undefined) return '/';
    let target = String(path).trim();
    if(!target) return '/';
    if(target.startsWith('http')){
      try{
        const url = new URL(target, location.origin);
        target = url.pathname + url.search;
      }catch{
        target = '/';
      }
    }
    if(target.startsWith('#')){
      target = target.replace(/^#/, '');
    }
    if(!target.startsWith('/')){
      target = '/' + target.replace(/^\/+/, '');
    }
    if(target.length>1 && target.endsWith('/')){
      target = target.replace(/\/+$/, '');
      if(!target) target = '/';
    }
    return target || '/';
  }

  function parseLocation(){
    const path = normalizePath(location.pathname);
    const query = new URLSearchParams(location.search || '');
    if(path === '/'){
      return { base: '', param: undefined, query };
    }
    const segments = path.slice(1).split('/');
    const base = segments[0] || '';
    const param = segments[1];
    return { base, param, query };
  }

  function render(){
    const route = parseLocation();
    const { base, param, query } = route;
    carouselSequence = 0;
    document.title = 'студия-гранита.рф — ' + titleFor(base);
    const app = $('#app');
    let html = '';
    if(base===''){ html = viewHome(); }
    else if(base==='catalog'){ html = viewCatalog({ query }); }
    else if(base==='about'){ html = viewAbout(); }
    else if(base==='contacts'){ html = viewContacts(); }
    else if(base==='product'){ html = viewProduct(param||''); }
    else { html = viewHome(); }
    app.innerHTML = html;
    window.scrollTo({ top: 0, behavior: 'smooth' });
    setActiveNav(base||'');
    wirePageInteractions();
  }

  window.addEventListener('popstate', render);

  function navigate(path, options={}){
    const { replace=false } = options;
    const normalized = normalizePath(path);
    const hasQuery = normalized.includes('?');
    const currentSearch = location.search;
    const target = hasQuery ? normalized : normalized + currentSearch;
    const current = location.pathname + location.search;
    if(replace){
      history.replaceState({}, '', target);
    }else if(current !== target){
      history.pushState({}, '', target);
    }
    render();
  }

  document.addEventListener('click', (event)=>{
    const anchor = event.target.closest('a');
    if(!anchor) return;
    const href = anchor.getAttribute('href');
    if(!href) return;
    if(anchor.target && anchor.target !== '_self') return;
    if(anchor.hasAttribute('download')) return;
    if(anchor.dataset.routerIgnore === 'true') return;
    if(href.startsWith('mailto:') || href.startsWith('tel:') || href.startsWith('javascript:')) return;
    if(href.startsWith('#')) return;
    if(/^https?:\/\//i.test(href)){
      try{
        const url = new URL(href, location.origin);
        if(url.origin !== location.origin) return;
        event.preventDefault();
        navigate(url.pathname + url.search);
        return;
      }catch{
        return;
      }
    }
    if(href.startsWith('/')){
      event.preventDefault();
      navigate(href);
    }
  });


  document.addEventListener('DOMContentLoaded', ()=>{
    $('#year').textContent = String(new Date().getFullYear());
    render();
    loadProducts();
    maybeRunTests();
  });
  // ---------------- Data loading ----------------
  async function loadProducts(){
    setState({ loading: true, error: null });
    try{
      const response = await fetch('/api/products');
      if(!response.ok){
        throw new Error('Не удалось получить список товаров');
      }
      const payload = await response.json();
      const items = Array.isArray(payload?.items) ? payload.items : [];
      const normalized = items.map(normalizeProduct);
      setState({ products: normalized, loading: false, error: null });
    }catch(error){
      console.error('Ошибка загрузки каталога', error);
      setState({ products: [], loading: false, error: 'Не удалось загрузить каталог. Попробуйте обновить страницу позже.' });
    }
  }

  // ---------------- Interactions ----------------
  /* Сделать обязательно: логика оверлея изображения товара */
  function setupProductImageOverlay(){
    const overlay = $('[data-product-image-overlay]');
    const overlayImage = overlay?.querySelector('[data-product-image-overlay-image]');
    if(!overlay || !overlayImage) return;

    const clearOverlay = () => {
      overlay.classList.remove('is-visible');
      overlayImage.removeAttribute('src');
      overlayImage.removeAttribute('alt');
      if(!overlay.hasAttribute('hidden')){
        overlay.setAttribute('hidden', '');
      }
      if(overlay.__lightboxKeydown){
        document.removeEventListener('keydown', overlay.__lightboxKeydown);
        overlay.__lightboxKeydown = null;
      }
    };

    const mainImage = document.querySelector('.product-main-image img');
    if(!mainImage){
      clearOverlay();
      return;
    }
    if(mainImage.dataset.overlayBound === '1') return;
    mainImage.dataset.overlayBound = '1';

    const handleKeydown = (event) => {
      if(event.key === 'Escape'){
        clearOverlay();
      }
    };

    const openOverlay = () => {
      const src = mainImage.currentSrc || mainImage.src;
      if(!src) return;
      overlayImage.src = src;
      overlayImage.alt = mainImage.alt || '';
      overlay.removeAttribute('hidden');
      requestAnimationFrame(() => overlay.classList.add('is-visible'));
      overlay.__lightboxKeydown = handleKeydown;
      document.addEventListener('keydown', handleKeydown);
    };

    if(!overlay.dataset.overlayClickBound){
      overlay.dataset.overlayClickBound = '1';
      overlay.addEventListener('click', (event) => {
        if(event.target === overlay){
          clearOverlay();
        }
      });
    }

    mainImage.addEventListener('click', (event) => {
      event.preventDefault();
      openOverlay();
    });
  }

  function wirePageInteractions(){
    // Modal open triggers
    $all('[data-action="callback"]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const pre = btn.getAttribute('data-prefill') || '';
        const text = pre ? ('Интересует памятник ' + pre.replace(/^Интересует\s*/,'')) : '';
        openModal(text);
      });
    });
    $all('.product-tile[data-link]').forEach(tile=>{
      if(tile.dataset.navBound === '1') return;
      tile.dataset.navBound = '1';
      tile.addEventListener('click', (event)=>{
        if(event.defaultPrevented) return;
        if(event.target.closest('[data-action="callback"], button')) return;
        const target = tile.getAttribute('data-link');
        if(target){
          event.preventDefault();
          navigate(target);
        }
      });
      tile.addEventListener('keydown', (event)=>{
        if(event.target !== tile) return;
        if(event.key === 'Enter' || event.key === ' '){
          event.preventDefault();
          const target = tile.getAttribute('data-link');
          if(target){
            navigate(target);
          }
        }
      });
    });
    setupCarousels();
    /* Сделать обязательно: активация увеличения изображения */
    setupProductImageOverlay();
  }


  function openModal(prefillComment=''){
    const bd = $('#modal-backdrop');
    $('#success').style.display = 'none';
    $('#callback-form').reset();
    if(prefillComment) $('#comment').value = prefillComment;
    bd.style.display = 'flex';
    bd.setAttribute('aria-hidden','false');
    $('#name').focus();
  }
  function closeModal(){
    const bd = $('#modal-backdrop');
    bd.style.display = 'none';
    bd.setAttribute('aria-hidden','true');
  }

  function normalizeDigits(v){ return v.replace(/\D/g,''); }
  function formatPhone(d){
    if(!d) return '';
    if(d[0]==='8') d='7'+d.slice(1);
    if(d[0]!=='7') d='7'+d;
    d = d.slice(0,11);
    let out = '+7 ';
    if(d.length>1){ out += '(' + d.slice(1,4); if(d.length>=4) out += ') '; }
    if(d.length>=7){ out += d.slice(4,7) + '-' + d.slice(7,9) + '-' + d.slice(9,11); }
    else if(d.length>4){ out += d.slice(4); }
    return out.trim();
  }

  $('#close-btn').addEventListener('click', closeModal);
  $('#modal-backdrop').addEventListener('click', (e)=>{
    if(e.target.id==='modal-backdrop') closeModal();
  });

  // Phone masking
  const phoneEl = $('#phone');
  phoneEl.addEventListener('input', ()=>{
    const digits = normalizeDigits(phoneEl.value);
    phoneEl.value = formatPhone(digits);
  });
  phoneEl.addEventListener('focus', ()=>{
    if(!phoneEl.value) phoneEl.value = '+7 (';
  });

  // Form validation + success
  $('#callback-form').addEventListener('submit', (e)=>{
    e.preventDefault();
    const name = $('#name').value.trim();
    const digits = normalizeDigits($('#phone').value);
    let ok = true;
    if(name.length<2){ ok=false; $('#err-name').style.display='block'; } else { $('#err-name').style.display='none'; }
    if(!(digits.length===11 && digits[0]==='7')){ ok=false; $('#err-phone').style.display='block'; } else { $('#err-phone').style.display='none'; }
    if(!ok) return;
    // Simulate submit
    const btn = $('#submit-btn'); btn.disabled = true; btn.textContent = 'Отправка...';
    setTimeout(()=>{
      btn.disabled = false; btn.textContent = 'Отправить';
      $('#success').style.display = 'block';
      setTimeout(()=>{ closeModal(); }, 1200);
    }, 700);
  });

  // ---------------- Tests (run with ?test=1) ----------------
  function expect(cond, msg){ if(!cond) throw new Error(msg); }
  function textIncludes(sel, substr){ const el = document.querySelector(sel); return !!el && !!el.textContent && el.textContent.includes(substr); }
  function count(sel){ return document.querySelectorAll(sel).length; }
  let testsScheduled = false;
  function maybeRunTests(){
    const params = new URLSearchParams(location.search);
    if(params.get('test')==='1' && !testsScheduled){
      testsScheduled = true;
      const waitForData = () => {
        if(state.loading){
          setTimeout(waitForData, 100);
          return;
        }
        setTimeout(runTests, 50);
      };
      waitForData();
    }
  }

  function runTests(){
    const prev = location.pathname + location.search;
    console.group('%cUI tests','color:gray');
    try{
      navigate('/', { replace: true });
      expect(textIncludes('h1','Мы создаём памятники'), 'Home: заголовок не найден');
      expect(count('#cta-home')===1, 'Home: основной CTA должен быть один');

      navigate('/catalog');
      if(state.products.length){
        expect(count('[data-testid^="product-card-"]')===state.products.length, 'Catalog: кол-во карточек не совпало');
        const firstProduct = state.products[0];
        navigate(`/product/${encodeURIComponent(firstProduct.id)}`);
        expect(textIncludes('h2', firstProduct.name || firstProduct.title || ''), 'Product: заголовок не совпал');
        expect(count('.product-price-amount')>=1, 'Product: цена не отображается');
        expect(count('.product-main-image')>=1, 'Product: изображения не отображаются');
      }else{
        expect(count('[data-testid^="product-card-"]')===0, 'Catalog: каталог должен быть пустым');
      }

      navigate('/about');
      expect(textIncludes('h2','О компании'), 'About: заголовок не найден');

      navigate('/contacts');
      expect(document.getElementById('ymap')!==null, 'Contacts: контейнер карты отсутствует');
      expect(textIncludes('.card','Заказать звонок'), 'Contacts: кнопка не найдена');

      console.log('%c✔ Все тесты пройдены','color:green');
    }catch(e){
      console.error('✘ Тест упал:', e.message);
    }finally{
      navigate(prev, { replace: true });
      console.groupEnd();
    }
  }
  </script>
</body>
</html>
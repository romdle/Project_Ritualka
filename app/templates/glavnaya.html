<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>студия-гранита.рф — Главная</title>
  <style>
  :root{ --accent:#246e37; --dark:#1E1E1E; --bg:#F6F6F6; --card:#ECECEC; --text:#2B2B2B; --maxw:1200px; }
  html,body{height:100%}
  body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .container{max-width:var(--maxw);margin:0 auto;padding:0 24px}
  /* Header */
  header{background:var(--dark)}
  .header-inner{height:100px;display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;align-items:center;gap:12px;color:#fff;text-decoration:none}
  .brand-badge{width:32px;height:32px;border-radius:999px;background:#ffffff1a}
  nav a{color:#fff;opacity:.9;text-decoration:none;padding:8px 12px;display:inline-block}
  nav a:hover{opacity:1}
  nav a.active{box-shadow:inset 0 -2px 0 0 var(--accent)}
  .btn-outline{border:1px solid var(--accent);background:transparent;color:#fff;border-radius:12px;padding:10px 16px;cursor:pointer}
  .btn-outline.dark-text{color:var(--text)}
  .btn-filled{background:var(--dark);color:#fff;border-radius:12px;padding:12px 18px;text-decoration:none;display:inline-block}
  /* Sections */
  .section{padding:48px 0;border-bottom:1px solid #E5E5E5}
  h1{font-size:40px;line-height:1.2;margin:0 0 16px}
  h2{font-size:28px;margin:0 0 16px}
  p{line-height:1.7;margin:0}
  /* Layout */
  .grid{display:grid;gap:24px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .row{display:flex;gap:16px;align-items:center}
  .row-wrap{display:flex;gap:16px;flex-wrap:wrap;align-items:center}
  /* Cards & media */
  .card{background:var(--card);border-radius:16px;padding:16px}
  .media{height:180px;border-radius:14px;background:linear-gradient(135deg,#d9d9d9,#c8c8c8);position:relative;overflow:hidden}
  .media::after{content:"";position:absolute;inset:0;opacity:.2;background-image:repeating-linear-gradient(45deg,#fff,#fff 6px,transparent 6px,transparent 12px)}
  .muted{opacity:.7}
  /* Footer */
  footer{background:var(--dark);color:#fff}
  footer a{color:#fff}
  .footer-top{padding:40px 0}
  .footer-bottom{border-top:1px solid rgba(255,255,255,.1);padding:16px 0;color:rgba(255,255,255,.7);font-size:12px}
  /* Utilities */
  .space-v-16{margin-top:16px}
  .space-v-8{margin-top:8px}
  .link{color:var(--text);text-decoration:none;border-bottom:1px solid transparent}
  .link:hover{border-color:var(--text)}
  /* Responsive */
  @media (max-width:960px){ .grid.cols-3{grid-template-columns:repeat(2,minmax(0,1fr))} }
  @media (max-width:680px){ .header-inner{height:88px} .grid.cols-2,.grid.cols-3{grid-template-columns:1fr} h1{font-size:30px} }
  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:24px;z-index:1000}
  .modal{background:#fff;border-radius:16px;max-width:520px;width:100%;padding:20px}
  .modal h3{margin:0 0 12px;font-size:22px}
  .form-row{display:flex;flex-direction:column;gap:6px;margin-top:10px}
  .form-row input, .form-row textarea{padding:12px;border-radius:10px;border:1px solid #ddd;font-size:16px}
  .form-actions{display:flex;gap:12px;align-items:center;margin-top:16px}
  .error{color:#b00020;font-size:13px;display:none}
  .success{display:none;padding:10px;border-radius:10px;background:#e7f7ea;border:1px solid #cdebd4;color:#1f6f3b;font-size:14px;margin-top:8px}
  .btn{cursor:pointer;padding:12px 16px;border-radius:12px;border:1px solid var(--accent);background:var(--accent);color:#fff}
  .btn.secondary{background:transparent;color:var(--text)}
  .hidden{display:none !important}
  /* Map placeholder */
  #ymap{height:360px;border-radius:12px;background:repeating-conic-gradient(from 0deg, #f1f1f1 0deg 20deg, #e7e7e7 20deg 40deg)}
  .map-note{font-size:12px;opacity:.7;margin-top:8px}
  </style>
</head>
<body>
  <header>
    <div class="container header-inner">
      <a href="#/" class="brand" data-link="home" aria-label="На главную">
        <div class="brand-badge" aria-hidden="true"></div>
        <strong>студия-гранита.рф</strong>
      </a>
      <nav class="row" aria-label="Главная навигация">
        <a href="#/catalog" data-link="catalog">Каталог</a>
        <a href="#/about" data-link="about">О компании</a>
        <a href="#/contacts" data-link="contacts">Контакты</a>
      </nav>
      <div class="row">
        <a href="tel:+74951234567" style="color:#fff;opacity:.9;text-decoration:none">+7 (495) 123-45-67</a>
      </div>
    </div>
  </header>

  <main id="app" role="main"></main>

  <footer>
    <div class="container footer-top">
      <div class="grid cols-3">
        <div>
          <div style="font-weight:600">студия-гранита.рф</div>
          <div class="space-v-8" style="opacity:.7;font-size:14px">Изготовление и установка памятников. Работаем с 20XX года.</div>
        </div>
        <div>
          <div style="font-weight:600" class="space-v-8">Навигация</div>
          <div class="row-wrap">
            <a href="#/catalog">Каталог</a>
            <a href="#/about">О компании</a>
            <a href="#/contacts">Контакты</a>
          </div>
        </div>
        <div>
          <div style="font-weight:600" class="space-v-8">Контакты</div>
          <div class="row-wrap">
            <a href="tel:+74951234567">+7 (495) 123-45-67</a>
            <a href="mailto:info@студия-гранита.рф">info@студия-гранита.рф</a>
          </div>
        </div>
      </div>
    </div>
    <div class="footer-bottom">
      <div class="container">© <span id="year"></span> студия-гранита.рф. Все права защищены.</div>
    </div>
  </footer>

  <!-- Unified Callback Modal -->
  <div class="modal-backdrop" id="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal" role="document" aria-labelledby="modal-title">
      <h3 id="modal-title">Заказать звонок</h3>
      <div id="success" class="success">Спасибо! Заявка отправлена. Мы свяжемся с вами в ближайшее время.</div>
      <form id="callback-form" novalidate>
        <div class="form-row">
          <label for="name">Имя*</label>
          <input id="name" name="name" type="text" placeholder="Ваше имя" autocomplete="name" required>
          <div id="err-name" class="error">Введите имя (минимум 2 символа)</div>
        </div>
        <div class="form-row">
          <label for="phone">Телефон*</label>
          <input id="phone" name="phone" type="tel" inputmode="tel" placeholder="+7 (___) ___-__-__" required>
          <div id="err-phone" class="error">Введите корректный телефон в формате +7 (XXX) XXX-XX-XX</div>
        </div>
        <div class="form-row">
          <label for="comment">Комментарий</label>
          <textarea id="comment" name="comment" rows="3" placeholder="Комментарий (опционально)"></textarea>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn" id="submit-btn">Отправить</button>
          <button type="button" class="btn secondary" id="close-btn">Закрыть</button>
        </div>
      </form>
    </div>
  </div>

  <script>
  // ---------------- Data ----------------
  const PRODUCTS = [
    { id:"S-01", title:"Памятник S-01", material:"Гранит чёрный", price:"48 000 ₽" },
    { id:"S-02", title:"Памятник S-02", material:"Габбро-диабаз", price:"52 000 ₽" },
    { id:"F-01", title:"Памятник F-01", material:"Гранит серый", price:"95 000 ₽" },
    { id:"F-02", title:"Памятник F-02", material:"Гранит чёрный", price:"110 000 ₽" },
    { id:"E-01", title:"Памятник E-01", material:"Мрамор белый", price:"по запросу" },
    { id:"E-02", title:"Памятник E-02", material:"Гранит красный", price:"по запросу" },
    { id:"D-01", title:"Памятник D-01", material:"Мрамор кремовый", price:"по запросу" },
    { id:"D-02", title:"Памятник D-02", material:"Гранит серый", price:"по запросу" }
  ];

  // ---------------- Helpers ----------------
  function $(sel, root=document){ return root.querySelector(sel); }
  function $all(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }
  function setActiveNav(base){
    $all('nav a').forEach(a=>a.classList.toggle('active', a.getAttribute('href')===('#/'+base)));
  }
  function titleFor(base){
    const map = { '':'Главная', catalog:'Каталог', about:'О компании', contacts:'Контакты', product:'Памятник' };
    return map[base] || 'Главная';
  }
  function priceText(p){ return p.price==='по запросу' ? 'Цена: по запросу' : ('от ' + p.price); }
  function media(height){ return '<div class="media" style="'+(height?('height:'+height+'px;'):'')+'"></div>'; }

  // Phone mask +7 (XXX) XXX-XX-XX
  function normalizeDigits(v){ return v.replace(/\D/g,''); }
  function formatPhone(d){
    // Expect 11 digits starting with 7; if first is 8, convert to 7 for formatting
    if(!d) return '';
    if(d[0]==='8') d='7'+d.slice(1);
    if(d[0]!=='7') d='7'+d; // force leading 7 if user typed 9/8 etc.
    d = d.slice(0,11);
    let out = '+7 ';
    if(d.length>1){ out += '(' + d.slice(1,4); if(d.length>=4) out += ') '; }
    if(d.length>=7){ out += d.slice(4,7) + '-' + d.slice(7,9) + '-' + d.slice(9,11); }
    else if(d.length>4){ out += d.slice(4); }
    return out.trim();
  }

  function openModal(prefillComment=''){
    const bd = $('#modal-backdrop');
    $('#success').style.display = 'none';
    $('#callback-form').reset();
    if(prefillComment) $('#comment').value = prefillComment;
    bd.style.display = 'flex';
    bd.setAttribute('aria-hidden','false');
    $('#name').focus();
  }
  function closeModal(){
    const bd = $('#modal-backdrop');
    bd.style.display = 'none';
    bd.setAttribute('aria-hidden','true');
  }

  // ---------------- Views ----------------
  function viewHome(){
    return `
      <section class="section">
        <div class="container">
          <div class="grid cols-2" style="align-items:center">
            <div>
              <h1>Мы создаём памятники с заботой и уважением</h1>
              <p>Мы сопровождаем семьи на каждом этапе: от выбора материала до установки. Работаем с натуральным гранитом, мрамором и габбро‑диабазом. Бережно относимся к традициям и деталям, чтобы память о близких сохраняла достоинство долгие годы.</p>
              <div class="space-v-16"></div>
              <div class="row">
                <a class="btn-filled" id="cta-home" href="#/catalog">Перейти в каталог</a>
              </div>
            </div>
            <div>
              ${media()}
              <div class="space-v-8 muted" style="font-size:12px">Фотография мастерской — замените на собственное изображение</div>
            </div>
          </div>
        </div>
      </section>
      <section class="section">
        <div class="container">
          <h2>Материалы, из которых мы работаем</h2>
          <div class="grid cols-3 space-v-16">
            ${[
              ["Гранит чёрный","Плотный, долговечный, глубокий блеск"],
              ["Мрамор белый","Классическая текстура, благородный оттенок"],
              ["Габбро-диабаз","Стойкость к атмосферным воздействиям"],
              ["Гранит серый","Нейтральный, универсальный рисунок"],
              ["Гранит красный","Акцентный, выразительный цвет"],
              ["Мрамор кремовый","Тёплый тон, мягкая фактура"],
            ].map(([name,note])=>`
              <div class="card">
                ${media(160)}
                <div class="space-v-8" style="font-weight:500">${name}</div>
                <div class="muted" style="font-size:14px">${note}</div>
              </div>
            `).join('')}
          </div>
        </div>
      </section>
      <section class="section" id="catalog-preview">
        <div class="container">
          ${[
            {title:'Стандартные', ids:['S-01','S-02']},
            {title:'Семейные', ids:['F-01','F-02']},
            {title:'Эксклюзивные', ids:['E-01','E-02']},
            {title:'Детские', ids:['D-01','D-02']},
          ].map(g=>`
            <div class="space-v-16">
              <h2>${g.title}</h2>
              <div class="grid cols-2">
                ${g.ids.map(id=>{
                  const p = PRODUCTS.find(x=>x.id===id);
                  return productCard(p);
                }).join('')}
              </div>
            </div>
          `).join('')}
        </div>
      </section>
    `;
  }

  function productCard(p){
    return `
      <article class="card" data-testid="product-card-${p.id}">
        ${media()}
        <div class="space-v-8" style="font-weight:500">${p.title}</div>
        <div class="muted" style="font-size:14px">Материал: ${p.material}</div>
        <div class="space-v-8" style="font-size:14px">${priceText(p)}</div>
        <a class="link" href="#/product/${p.id}" aria-label="Подробнее о ${p.title}">Подробнее →</a>
      </article>
    `;
  }

  function viewCatalog(){
    return `
      <section class="section">
        <div class="container">
          <h2>Каталог памятников</h2>
          <div class="grid cols-3 space-v-16">
            ${PRODUCTS.map(p=>productCard(p)).join('')}
          </div>
        </div>
      </section>
    `;
  }

  function viewAbout(){
    return `
      <section class="section">
        <div class="container">
          <div class="grid cols-2" style="align-items:center">
            <div>
              <h2>О компании</h2>
              <p>Наша миссия — сохранять память о близких с уважением и тактом. Мы уделяем внимание каждой детали: от выбора камня и разработки эскиза до монтажа и ухода. Используем проверенные материалы и технологии, чтобы памятник на долгие годы сохранял форму и красоту.</p>
              <div class="space-v-16"></div>
              <p class="muted">Мы открыты к диалогу, бережно работаем с пожеланиями семьи и придерживаемся сроков.</p>
            </div>
            <div>${media()}</div>
          </div>
        </div>
      </section>
    `;
  }

  function similarList(id){
    const group = id.split('-')[0];
    const similar = PRODUCTS.filter(x=>x.id!==id && x.id.startsWith(group)).slice(0,2);
    const fallbacks = PRODUCTS.filter(x=>x.id!==id).slice(0,3);
    return (similar.length? similar: fallbacks);
  }

  function viewProduct(id){
    const p = PRODUCTS.find(x=>x.id===id);
    if(!p){ location.hash = '#/catalog'; return ''; }
    const list = similarList(id);
    return `
      <section class="section">
        <div class="container">
          <div class="grid cols-2" style="align-items:start">
            <div>
              ${media(360)}
              <div class="grid cols-3 space-v-16">
                ${media(120)}${media(120)}${media(120)}
              </div>
            </div>
            <div>
              <h2>${p.title}</h2>
              <div class="space-v-8 muted">Материал: ${p.material}</div>
              <div class="space-v-8" style="font-size:18px">${priceText(p)}</div>
              <div class="space-v-16"></div>
              <button class="btn-outline dark-text" style="border-color:var(--accent)" data-action="callback" data-prefill="Интересует ${p.title}">Заказать звонок</button>
            </div>
          </div>
          <div class="space-v-16"></div>
          <h2>Похожие памятники</h2>
          <div class="grid cols-3 space-v-16">
            ${list.map(pp=>productCard(pp)).join('')}
          </div>
        </div>
      </section>
    `;
  }

  function viewContacts(){
    return `
      <section class="section">
        <div class="container">
          <h2>Свяжитесь с нами</h2>
          <div class="space-v-16"></div>
          <div class="card">
            <div class="row-wrap" style="font-size:16px">
              <div><strong>Телефон:</strong> <a class="link" href="tel:+74951234567">+7 (495) 123‑45‑67</a></div>
              <div><strong>E‑mail:</strong> <a class="link" href="mailto:info@студия-гранита.рф">info@студия‑гранита.рф</a></div>
              <div><strong>Адрес:</strong> г. Москва, ул. Примерная, 12</div>
              <div><strong>Часы:</strong> Пн–Сб 10:00–18:00</div>
            </div>
            <div class="space-v-16"></div>
            <button class="btn-outline dark-text" style="border-color:var(--accent)" data-action="callback">Заказать звонок</button>
          </div>
          <div class="space-v-16"></div>
          <div class="card">
            <div id="ymap" aria-label="Карта (плейсхолдер)"></div>
            <div class="map-note">Интерактивная карта временно отключена. Используется плейсхолдер для прохождения автотестов (#ymap).</div>
          </div>
        </div>
      </section>
    `;
  }

  // ---------------- Router ----------------
  function parseHash(){
    const hash = location.hash || '#/';
    const parts = hash.split('/');
    const base = parts[1] || '';
    const param = parts[2];
    return { base, param };
  }
  function render(){
    const { base, param } = parseHash();
    document.title = 'студия-гранита.рф — ' + titleFor(base);
    const app = $('#app');
    let html = '';
    if(base==='' ){ html = viewHome(); }
    else if(base==='catalog'){ html = viewCatalog(); }
    else if(base==='about'){ html = viewAbout(); }
    else if(base==='contacts'){ html = viewContacts(); }
    else if(base==='product'){ html = viewProduct(param||''); }
    else { html = viewHome(); }
    app.innerHTML = html;
    setActiveNav(base||'');
    wirePageInteractions();
  }

  window.addEventListener('hashchange', render);
  document.addEventListener('DOMContentLoaded', ()=>{
    $('#year').textContent = String(new Date().getFullYear());
    render();
    maybeRunTests();
  });

  // ---------------- Interactions ----------------
  function wirePageInteractions(){
    // Modal open triggers
    $all('[data-action="callback"]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const pre = btn.getAttribute('data-prefill') || '';
        const text = pre ? ('Интересует памятник ' + pre.replace(/^Интересует\\s*/,'') ) : '';
        openModal(text);
      });
    });
  }

  // Modal UI
  $('#close-btn').addEventListener('click', closeModal);
  $('#modal-backdrop').addEventListener('click', (e)=>{
    if(e.target.id==='modal-backdrop') closeModal();
  });

  // Phone masking
  const phoneEl = $('#phone');
  phoneEl.addEventListener('input', ()=>{
    const digits = normalizeDigits(phoneEl.value);
    phoneEl.value = formatPhone(digits);
  });
  phoneEl.addEventListener('focus', ()=>{
    if(!phoneEl.value) phoneEl.value = '+7 (';
  });

  // Form validation + success
  $('#callback-form').addEventListener('submit', (e)=>{
    e.preventDefault();
    const name = $('#name').value.trim();
    const digits = normalizeDigits($('#phone').value);
    let ok = true;
    if(name.length<2){ ok=false; $('#err-name').style.display='block'; } else { $('#err-name').style.display='none'; }
    if(!(digits.length===11 && digits[0]==='7')){ ok=false; $('#err-phone').style.display='block'; } else { $('#err-phone').style.display='none'; }
    if(!ok) return;
    // Simulate submit
    const btn = $('#submit-btn'); btn.disabled = true; btn.textContent = 'Отправка...';
    setTimeout(()=>{
      btn.disabled = false; btn.textContent = 'Отправить';
      $('#success').style.display = 'block';
      setTimeout(()=>{ closeModal(); }, 1200);
    }, 700);
  });

  // ---------------- Tests (run with ?test=1) ----------------
  function expect(cond, msg){ if(!cond) throw new Error(msg); }
  function textIncludes(sel, substr){ const el = document.querySelector(sel); return !!el && !!el.textContent && el.textContent.includes(substr); }
  function count(sel){ return document.querySelectorAll(sel).length; }
  function navigate(hash){ window.location.hash = hash; }
  function maybeRunTests(){
    const params = new URLSearchParams(location.search);
    if(params.get('test')==='1'){ setTimeout(runTests, 50); }
  }
  function runTests(){
    const prev = window.location.hash;
    console.group('%cUI tests','color:gray');
    try{
      navigate('#/');
      expect(textIncludes('h1','Мы создаём памятники'), 'Home: заголовок не найден');
      // Home has exactly one primary CTA button
      expect(count('#cta-home')===1, 'Home: основной CTA должен быть один');

      navigate('#/catalog');
      expect(count('[data-testid^="product-card-"]')===PRODUCTS.length, 'Catalog: кол-во карточек не совпало');

      navigate('#/product/S-01');
      expect(textIncludes('h2','Памятник S-01'), 'Product: заголовок не совпал');
      expect(count('.media')>=4, 'Product: не хватает изображений');

      navigate('#/product/E-01');
      expect(textIncludes('section .container','Цена: по запросу'), 'Product: логика цены по запросу неверна');

      navigate('#/about');
      expect(textIncludes('h2','О компании'), 'About: заголовок не найден');

      navigate('#/contacts');
      expect(document.getElementById('ymap')!==null, 'Contacts: контейнер карты отсутствует');
      // Modal button presence
      expect(textIncludes('.card','Заказать звонок'), 'Contacts: кнопка не найдена');

      console.log('%c✔ Все тесты пройдены','color:green');
    }catch(e){
      console.error('✘ Тест упал:', e.message);
    }finally{
      window.location.hash = prev;
      console.groupEnd();
    }
  }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>студия-гранита.рф — Главная</title>
  <style>
  :root{
    --accent:#246e37;
    --dark:#1E1E1E;
    --bg:#F6F6F6;
    --card:#ECECEC;
    --text:#2B2B2B;
    --container-max:96%;
    --space-xs:1.2vw;
    --space-sm:2vw;
    --space-md:3.4vw;
    --space-lg:5.2vw;
    --space-xl:8vw;
    --radius-sm:4%;
    --radius-md:6%;
    --radius-lg:10%;
  }
  *{box-sizing:border-box;}
  html{height:100%;scroll-behavior:smooth;}
  body{margin:0;min-height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;font-size:clamp(94%,1.05vw,110%);line-height:1.6;}
  img,video{max-width:100%;height:auto;display:block;}
  a{text-decoration:none;color:inherit;}
  main{display:block;}
  .container{width:var(--container-max);max-width:var(--container-max);margin:0 auto;}
  header{position:sticky;top:0;width:100%;background:var(--dark);z-index:40;}
  .header-inner{display:flex;align-items:center;justify-content:space-between;gap:var(--space-sm);padding:calc(var(--space-xs)*1.4) 0;}
  .brand{display:flex;align-items:center;gap:calc(var(--space-xs)*0.7);color:#fff;}
  .brand-badge{width:5vw;height:5vw;max-width:12%;max-height:12%;border-radius:50%;background:rgba(255,255,255,0.12);}
  nav{display:flex;align-items:center;gap:calc(var(--space-xs)*0.8);}
  nav a{color:#fff;opacity:0.9;padding:calc(var(--space-xs)*0.6) calc(var(--space-xs));border-radius:var(--radius-sm);transition:opacity 0.3s ease,background 0.3s ease;}
  nav a:hover,nav a:focus-visible{opacity:1;background:rgba(255,255,255,0.08);}
  nav a.active{background:rgba(255,255,255,0.16);}
  .header-contact{color:#fff;opacity:0.9;display:inline-flex;align-items:center;padding:calc(var(--space-xs)*0.6) calc(var(--space-xs));border-radius:var(--radius-sm);transition:background 0.3s ease;}
  .header-contact:hover,.header-contact:focus-visible{background:rgba(255,255,255,0.12);}
  .hero-section{position:relative;background:linear-gradient(135deg,#1f2937,#111827);overflow:hidden;}
  .hero-section::before{content:"";position:absolute;inset:0;background-image:var(--hero-bg-image,none);background-size:cover;background-position:center;opacity:0.58;mix-blend-mode:screen;filter:saturate(120%);}
  .hero-section::after{content:"";position:absolute;inset:0;background:rgba(80,110,200,0.35);mix-blend-mode:multiply;}
  .hero-inner{position:relative;z-index:1;display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:var(--space-lg);padding:var(--space-xl) 0;}
  .hero-content{flex:1 1 48%;display:flex;flex-direction:column;gap:var(--space-sm);max-width:60%;}
  .hero-title{color:#fff;margin:0;font-family:Georgia,serif;font-size:clamp(190%,4.6vw,280%);line-height:1.3;font-weight:400;}
  .hero-text{color:rgba(255,255,255,0.72);margin:0;font-size:clamp(110%,2.4vw,140%);}
  .hero-actions{display:flex;flex-wrap:wrap;gap:var(--space-sm);}
  .hero-button{display:inline-flex;align-items:center;justify-content:center;background:var(--accent);color:#fff;font-weight:500;border-radius:999px;padding:calc(var(--space-xs)*0.9) calc(var(--space-md));font-size:clamp(110%,2.8vw,130%);letter-spacing:0.04em;transition:transform 0.3s ease,background 0.3s ease;min-width:32%;min-height:9vh;box-shadow:0 1.4vw 2.8vw rgba(36,110,55,0.25);}
  .hero-button:hover,.hero-button:focus-visible{background:#1e5a2d;transform:translateY(-1vw);}
  .hero-media{flex:1 1 38%;display:flex;flex-direction:column;gap:var(--space-xs);align-items:flex-start;}
  .hero-media .media{width:100%;aspect-ratio:4/3;border-radius:var(--radius-lg);overflow:hidden;background:rgba(255,255,255,0.08);backdrop-filter:blur(6px);}
  .hero-media-note{color:rgba(255,255,255,0.7);font-size:clamp(82%,1.8vw,100%);}
  .section{padding:var(--space-lg) 0;border-bottom:1px solid rgba(0,0,0,0.08);}
  h1,h2,h3{margin:0;font-family:Georgia,serif;font-weight:400;}
  h1{font-size:clamp(180%,4vw,240%);}
  h2{font-size:clamp(150%,3.6vw,210%);}
  p{margin:0;line-height:1.8;}
  .muted{opacity:0.7;}
  .grid{display:grid;gap:var(--space-md);}
  .grid.cols-3{grid-template-columns:repeat(auto-fit,minmax(26%,1fr));}
  .grid.cols-2{grid-template-columns:repeat(auto-fit,minmax(40%,1fr));}
  .row{display:flex;align-items:center;gap:var(--space-xs);}
  .row-wrap{display:flex;flex-wrap:wrap;gap:var(--space-xs);}
  .product-row{display:grid;gap:var(--space-md);grid-template-columns:repeat(auto-fit,minmax(42%,1fr));}
  .product-row.product-row--home{margin-top:var(--space-sm);margin-bottom:var(--space-md);}
  .product-tile{display:flex;flex-direction:column;gap:var(--space-sm);background:var(--card);border-radius:var(--radius-md);padding:calc(var(--space-sm));transition:transform 0.3s ease,box-shadow 0.3s ease;min-height:clamp(48vh,58%,68vh);}
  .product-tile:hover{transform:translateY(-1.2vw);box-shadow:0 1.2vw 2.6vw rgba(0,0,0,0.1);}
  .product-image-link{display:block;width:100%;aspect-ratio:3/4;border-radius:calc(var(--radius-md)*0.8);overflow:hidden;background:linear-gradient(135deg,#d9d9d9,#c8c8c8);border:0.2vw solid rgba(0,0,0,0.04);}
  .product-image-link img{width:100%;height:100%;object-fit:cover;transition:transform 0.35s ease;}
  .product-image-link:hover img,.product-image-link:focus-visible img{transform:scale(1.05);}
  .product-name{color:var(--text);font-size:clamp(120%,2.4vw,150%);line-height:1.5;}
  .product-price{color:var(--text);font-weight:600;font-size:clamp(110%,2.2vw,140%);}
  .product-tile-description{color:#6B6B6B;font-size:clamp(96%,2vw,118%);line-height:1.6;}
  .product-tile-more{color:var(--accent);font-size:clamp(96%,2vw,118%);}
  .product-detail{display:grid;grid-template-columns:minmax(0,48%) minmax(0,48%);gap:var(--space-md);align-items:start;}
  .product-main-image{width:100%;aspect-ratio:3/4;border-radius:var(--radius-lg);overflow:hidden;background:linear-gradient(135deg,#d9d9d9,#c8c8c8);border:0.2vw solid rgba(0,0,0,0.05);}
  .product-main-image img{width:100%;height:100%;object-fit:cover;}
  .product-info{display:flex;flex-direction:column;gap:var(--space-md);background:rgba(255,255,255,0.92);border-radius:var(--radius-lg);padding:calc(var(--space-md));backdrop-filter:blur(0.4vw);}
  .product-title{font-size:clamp(170%,4.2vw,240%);}
  .product-description-text{color:#6B6B6B;font-size:clamp(98%,2vw,120%);line-height:1.8;}
  .product-category-pill{display:inline-block;padding:calc(var(--space-xs)*0.4) calc(var(--space-xs));background:rgba(36,110,55,0.12);color:var(--accent);border-radius:999px;font-size:clamp(86%,1.6vw,100%);letter-spacing:0.05em;}
  .product-price-amount{font-size:clamp(160%,3.8vw,220%);color:var(--text);}
  .product-divider{width:100%;height:0.3vh;background:rgba(0,0,0,0.08);}
  .description-heading{font-size:clamp(120%,2.6vw,150%);margin-bottom:calc(var(--space-xs)*0.6);}
  .category-heading{color:var(--text);font-size:clamp(150%,3.4vw,210%);margin:0;}
  .back-link{display:inline-flex;align-items:center;gap:calc(var(--space-xs)*0.6);color:#6B6B6B;margin-bottom:var(--space-sm);font-size:clamp(96%,2vw,118%);transition:color 0.3s ease;}
  .back-link:hover,.back-link:focus-visible{color:var(--accent);}
  .callback-button{width:100%;display:inline-flex;align-items:center;justify-content:center;gap:calc(var(--space-xs)*0.7);padding:calc(var(--space-xs)*1.2) calc(var(--space-md));background:var(--accent);color:#fff;border-radius:999px;font-size:clamp(110%,2.6vw,140%);font-weight:500;min-height:9vh;transition:background 0.3s ease,transform 0.3s ease;border:none;}
  .callback-button:hover,.callback-button:focus-visible{background:#1e5a2d;transform:translateY(-0.8vw);}
  .similar-header{font-size:clamp(170%,4vw,230%);margin-bottom:calc(var(--space-xs));}
  .similar-accent{width:24%;height:0.4vh;background:var(--accent);margin-bottom:calc(var(--space-sm)*0.6);}
  .product-support-note{color:#6B6B6B;font-size:clamp(92%,1.8vw,110%);text-align:center;}
  .materials-section{padding:var(--space-lg) 0;}
  .materials-header{text-align:center;max-width:78%;margin:0 auto var(--space-md);}
  .materials-title{font-size:clamp(180%,4.2vw,240%);margin-bottom:calc(var(--space-xs));}
  .materials-accent{width:18%;height:0.4vh;background:var(--accent);margin:0 auto calc(var(--space-xs));}
  .materials-description{color:#6B6B6B;font-size:clamp(98%,2vw,118%);margin:0 auto;}
  .materials-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(30%,1fr));gap:var(--space-md);width:86%;margin:0 auto;}
  .align-center{align-items:center;}
  .section-intro{text-align:center;padding:calc(var(--space-md)) 0 calc(var(--space-xs));}
  .section-intro-title{font-family:Georgia,serif;font-size:clamp(180%,4vw,240%);font-weight:400;line-height:1.3;}
  .section-intro-accent{width:18%;height:0.4vh;background:var(--accent);margin:calc(var(--space-xs)*0.6) auto 0;border-radius:var(--radius-sm);}
  .material-card{background:var(--card);border-radius:var(--radius-lg);padding:calc(var(--space-sm));display:flex;flex-direction:column;align-items:center;gap:var(--space-sm);text-align:center;}
  .material-image{width:100%;aspect-ratio:1/1;border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#d9d9d9,#c8c8c8);color:#6B6B6B;font-size:clamp(70%,1.4vw,90%);letter-spacing:0.4em;text-transform:uppercase;}
  .material-text{color:#6B6B6B;font-size:clamp(94%,2vw,112%);line-height:1.6;}
  .section-header{display:flex;align-items:center;justify-content:space-between;gap:var(--space-xs);flex-wrap:wrap;}
  .btn-view-all{border:0.2vw solid var(--accent);color:var(--accent);border-radius:999px;padding:calc(var(--space-xs)*0.6) calc(var(--space-xs)*1.4);font-size:clamp(96%,2vw,118%);display:inline-flex;align-items:center;gap:calc(var(--space-xs)*0.4);}
  .btn-view-all:hover,.btn-view-all:focus-visible{background:rgba(36,110,55,0.12);}
  .status-card{background:var(--card);border-radius:var(--radius-md);padding:calc(var(--space-sm));font-size:clamp(96%,2vw,118%);width:100%;display:block;}
  .status-card.error{border:0.3vw solid #e57373;background:rgba(253,236,234,0.9);color:#8a1c1c;}
  footer{background:var(--dark);color:#fff;}
  .footer-top{padding:var(--space-lg) 0;}
  .footer-top-title{font-weight:600;margin-bottom:calc(var(--space-xs)*0.6);}
  .footer-muted{opacity:0.7;font-size:clamp(86%,1.8vw,100%);}
  .footer-bottom{border-top:1px solid rgba(255,255,255,0.12);padding:calc(var(--space-xs)*0.8) 0;color:rgba(255,255,255,0.7);font-size:clamp(70%,1.6vw,90%);}
  .space-v-16{margin-top:var(--space-sm);}
  .space-v-8{margin-top:calc(var(--space-xs)*0.6);}
  .space-v-24{margin-top:var(--space-lg);}
  .link{color:var(--text);border-bottom:0.2vw solid transparent;}
  .link:hover,.link:focus-visible{border-color:var(--text);}
  .card{background:var(--card);border-radius:var(--radius-md);padding:calc(var(--space-sm));}
  .media{height:auto;aspect-ratio:16/9;border-radius:var(--radius-md);background:linear-gradient(135deg,#d9d9d9,#c8c8c8);display:flex;align-items:center;justify-content:center;overflow:hidden;}
  .media img{width:100%;height:100%;object-fit:cover;}
  #ymap{height:45vh;border-radius:var(--radius-md);background:repeating-conic-gradient(from 0deg,#f1f1f1 0deg 20deg,#e7e7e7 20deg 40deg);}
  .map-note{font-size:clamp(78%,1.6vw,96%);opacity:0.7;margin-top:calc(var(--space-xs)*0.5);}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;padding:var(--space-sm);z-index:60;}
  .modal{background:#fff;border-radius:var(--radius-lg);width:100%;max-width:88%;padding:calc(var(--space-sm));display:flex;flex-direction:column;gap:var(--space-sm);}
  .modal h3{margin:0;font-size:clamp(140%,3.4vw,190%);}
  .form-row{display:flex;flex-direction:column;gap:calc(var(--space-xs)*0.4);}
  .form-row input,.form-row textarea{padding:calc(var(--space-xs)*0.8);border-radius:var(--radius-sm);border:0.2vw solid #ddd;font-size:clamp(96%,2vw,118%);}
  .form-actions{display:flex;gap:var(--space-xs);align-items:center;flex-wrap:wrap;}
  .btn{cursor:pointer;padding:calc(var(--space-xs)*0.8) calc(var(--space-xs)*1.2);border-radius:999px;border:0.2vw solid var(--accent);background:var(--accent);color:#fff;font-size:clamp(96%,2vw,118%);min-height:8vh;min-width:26%;display:inline-flex;align-items:center;justify-content:center;}
  .btn.secondary{background:transparent;color:var(--text);}
  .btn-outline{border:0.2vw solid var(--accent);background:transparent;color:var(--accent);border-radius:999px;padding:calc(var(--space-xs)*0.8) calc(var(--space-xs)*1.4);font-size:clamp(96%,2vw,118%);min-height:8vh;min-width:26%;display:inline-flex;align-items:center;justify-content:center;transition:background 0.3s ease,color 0.3s ease;}
  .btn-outline.dark-text{color:var(--text);}
  .btn-outline:hover,.btn-outline:focus-visible{background:rgba(36,110,55,0.12);}
  .btn-filled{background:var(--dark);color:#fff;border-radius:999px;padding:calc(var(--space-xs)*0.8) calc(var(--space-xs)*1.4);min-height:8vh;min-width:26%;display:inline-flex;align-items:center;justify-content:center;font-size:clamp(96%,2vw,118%);transition:background 0.3s ease;}
  .btn-filled:hover,.btn-filled:focus-visible{background:rgba(30,30,30,0.85);}
  .contact-details{font-size:clamp(98%,2vw,120%);gap:calc(var(--space-xs)*0.8);}
  .error{color:#b00020;font-size:clamp(78%,1.6vw,96%);display:none;}
  .success{display:none;padding:calc(var(--space-xs)*0.8);border-radius:var(--radius-sm);background:rgba(231,247,234,0.9);border:0.2vw solid #cdebd4;color:#1f6f3b;font-size:clamp(88%,1.8vw,102%);}
  @media screen and (max-width: 1024px){
    .hero-inner{flex-direction:column;align-items:flex-start;}
    .hero-content{max-width:100%;}
    .hero-media{width:100%;}
    .product-detail{grid-template-columns:1fr;}
    .product-row{grid-template-columns:repeat(auto-fit,minmax(60%,1fr));}
    .materials-grid{width:94%;grid-template-columns:repeat(auto-fit,minmax(44%,1fr));}
  }
  @media screen and (max-width: 768px){
    body{font-size:clamp(96%,2.4vw,120%);}
    .header-inner{flex-direction:column;align-items:flex-start;}
    nav{flex-wrap:wrap;}
    .hero-inner{padding:var(--space-lg) 0;}
    .hero-media{display:none;}
    .product-row{grid-template-columns:repeat(auto-fit,minmax(84%,1fr));}
    .materials-grid{grid-template-columns:repeat(auto-fit,minmax(72%,1fr));}
    .hero-button,.callback-button,.btn,.btn-filled{min-width:60%;}
  }
  @media screen and (max-width: 480px){
    .container{width:92%;}
    .hero-actions{flex-direction:column;}
    .product-row{grid-template-columns:1fr;}
    .materials-grid{grid-template-columns:1fr;}
    .modal{padding:calc(var(--space-xs)*1.2);}
    .form-actions{flex-direction:column;align-items:stretch;}
    .btn{width:100%;min-width:0;}
  }
  </style>
</head>
<body>
  <header>
    <div class="container header-inner">
      <a href="/" class="brand" data-route="" aria-label="На главную">
        <div class="brand-badge" aria-hidden="true"></div>
        <strong>студия-гранита.рф</strong>
      </a>
      <nav class="row" aria-label="Главная навигация">
        <a href="/catalog" data-route="catalog">Каталог</a>
        <a href="/about" data-route="about">О компании</a>
        <a href="/contacts" data-route="contacts">Контакты</a>
      </nav>
      <div class="row">
        <a href="tel:+74951234567" class="header-contact">+7 (495) 123-45-67</a>
      </div>
    </div>
  </header>

  <main id="app" role="main"></main>

  <footer>
    <div class="container footer-top">
      <div class="grid cols-3">
        <div>
          <div class="footer-top-title">студия-гранита.рф</div>
          <div class="space-v-8 footer-muted">Изготовление и установка памятников. Работаем с 20XX года.</div>
        </div>
        <div>
          <div class="footer-top-title space-v-8">Навигация</div>
          <div class="row-wrap">
            <a href="/catalog" data-route="catalog">Каталог</a>
            <a href="/about" data-route="about">О компании</a>
            <a href="/contacts" data-route="contacts">Контакты</a>
          </div>
        </div>
        <div>
          <div class="footer-top-title space-v-8">Контакты</div>
          <div class="row-wrap footer-muted">
            <a href="tel:+74951234567">+7 (495) 123-45-67</a>
            <a href="mailto:info@студия-гранита.рф">info@студия-гранита.рф</a>
          </div>
        </div>
      </div>
    </div>
    <div class="footer-bottom">
      <div class="container">© <span id="year"></span> студия-гранита.рф. Все права защищены.</div>
    </div>
  </footer>

  <!-- Unified Callback Modal -->
  <div class="modal-backdrop" id="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal" role="document" aria-labelledby="modal-title">
      <h3 id="modal-title">Заказать звонок</h3>
      <div id="success" class="success">Спасибо! Заявка отправлена. Мы свяжемся с вами в ближайшее время.</div>
      <form id="callback-form" novalidate>
        <div class="form-row">
          <label for="name">Имя*</label>
          <input id="name" name="name" type="text" placeholder="Ваше имя" autocomplete="name" required>
          <div id="err-name" class="error">Введите имя (минимум 2 символа)</div>
        </div>
        <div class="form-row">
          <label for="phone">Телефон*</label>
          <input id="phone" name="phone" type="tel" inputmode="tel" placeholder="+7 (___) ___-__-__" required>
          <div id="err-phone" class="error">Введите корректный телефон в формате +7 (XXX) XXX-XX-XX</div>
        </div>
        <div class="form-row">
          <label for="comment">Комментарий</label>
          <textarea id="comment" name="comment" rows="3" placeholder="Комментарий (опционально)"></textarea>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn" id="submit-btn">Отправить</button>
          <button type="button" class="btn secondary" id="close-btn">Закрыть</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ---------------- State ----------------
  const state = {
    products: [],
    loading: true,
    error: null,
  };

  const CATEGORY_TITLES = {
    'Стандартный': 'Стандартный',
    'Стандартные памятники': 'Стандартный',
    'Семейный': 'Семейный',
    'Семейные памятники': 'Семейный',
    'Эксклюзивный': 'Эксклюзивный',
    'Эксклюзивные памятники': 'Эксклюзивный',
    'Детский': 'Детский',
    'Детские памятники': 'Детский',
  };

  const CATEGORY_ORDER = [
    'Стандартный',
    'Стандартные памятники',
    'Семейный',
    'Семейные памятники',
    'Эксклюзивный',
    'Эксклюзивные памятники',
    'Детский',
    'Детские памятники',
  ];

  // ---------------- Helpers ----------------
  function $(sel, root=document){ return root.querySelector(sel); }
  function $all(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }
  
  function setState(partial){
    Object.assign(state, partial);
    render();
  }

  function setActiveNav(base){
    const activeBase = base === 'product' ? 'catalog' : base;
    $all('nav a[data-route]').forEach(a=>{
      const route = a.getAttribute('data-route') || '';
      a.classList.toggle('active', route === activeBase);
    });
  }
  function titleFor(base){
    const map = { '':'Главная', catalog:'Каталог', about:'О компании', contacts:'Контакты', product:'Памятник' };
    return map[base] || 'Главная';
  }
  
  function escapeHtml(value){
    if(value === null || value === undefined) return '';
    return String(value)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function escapeAttribute(value){
    return escapeHtml(value).replace(/\r/g,'').replace(/\n/g,'&#10;');
  }
  function resolveImagePath(path){
    if(!path) return '';
    const raw = String(path).trim();
    if(!raw) return '';
    if(/^https?:\/\//i.test(raw)) return raw;
    if(raw.startsWith('/')) return raw;
    const normalized = raw.replace(/^\.\/?/, '').replace(/^\/+/, '');
    if(normalized.startsWith('static/')){
      return '/' + normalized.replace(/^\/+/, '');
    }
    return '/static/' + normalized;
  }

  function productImage(product){
    const image = product?.img_path ?? product?.image_path ?? '';
    return resolveImagePath(image);
  }

  function displayCategoryName(category){
    const raw = (category ?? '').trim();
    if(!raw) return 'Без категории';
    return CATEGORY_TITLES[raw] || raw;
  }

  function productLink(id){
    return '/product/' + encodeURIComponent(String(id));
  }

  function priceText(product){
    if(!product) return 'по запросу';
    const value = product.price;
    if(value === null || value === undefined || value === ''){
      return 'по запросу';
    }
    const num = Number(value);
    if(Number.isFinite(num)){
      return new Intl.NumberFormat('ru-RU').format(num) + ' ₽';
    }
    const textValue = String(value).trim();
    if(!textValue){
      return 'Цена: по запросу';
    }
    if(/^по запросу$/i.test(textValue)){
      return 'по запросу';
    }
    return 'от ' + escapeHtml(textValue);
  }

  function priceValue(product){
    const full = priceText(product);
    return full.replace(/^от\s*/i, '').trim();
  }

  function formatTextBlock(text){
    if(text === null || text === undefined) return '';
    return escapeHtml(String(text)).replace(/\r?\n/g,'<br>');
  }

  function snippet(text, limit=90){
    if(text === null || text === undefined) return '';
    const str = String(text).trim();
    if(str.length <= limit) return str;
    return str.slice(0, limit - 1) + '…';
  }

  function getProductById(id){
    return state.products.find(p => String(p.id) === String(id));
  }

  function similarList(product){
    if(!product) return [];
    const currentId = String(product.id);
    const targetCategory = (product.category ?? '').trim().toLowerCase();
    const sameCategory = state.products
      .filter(p => String(p.id) !== currentId && (p.category ?? '').trim().toLowerCase() === targetCategory)
      .slice(0, 3);
    if(sameCategory.length) return sameCategory;
    const standardCategory = state.products
      .filter(p => String(p.id) !== currentId && (p.category ?? '').trim().toLowerCase() === 'стандартный')
      .slice(0, 3);
    if(standardCategory.length) return standardCategory;
    return state.products.filter(p => String(p.id) !== currentId).slice(0, 3);
  }

  function media(height, imageUrl='', altText=''){
    if(imageUrl){
      const safeUrl = escapeAttribute(imageUrl);
      const safeAlt = escapeHtml(altText || 'Изображение памятника');
      return `<div class="media has-image"><img src="${safeUrl}" alt="${safeAlt}" loading="lazy"></div>`;
    }
    return `<div class="media"></div>`;
  }

  function normalizeProduct(raw){
    if(!raw || typeof raw !== 'object') return {};
    return {
      id: raw.id,
      name: raw.name ?? raw.title ?? '',
      price: raw.price,
      description: raw.description ?? '',
      img_path: raw.img_path ?? raw.image_path ?? '',
      category: raw.category ?? '',
    };
  }

  function renderStatus(message, isError=false){
    const safe = escapeHtml(message);
    const extra = isError ? ' error' : '';
    return `<div class="status-card${extra}">${safe}</div>`;
  }

  function orderedCategories(){
    const groups = new Map();
    state.products.forEach(product => {
      const raw = (product.category ?? '').trim();
      const key = raw || 'Без категории';
      if(!groups.has(key)){
        groups.set(key, []);
      }
      groups.get(key).push(product);
    });
    const entries = Array.from(groups.entries()).map(([key, items]) => ({
      key,
      display: displayCategoryName(key),
      items,
    }));
    const index = (name) => {
      const raw = (name ?? '').trim();
      const idx = CATEGORY_ORDER.indexOf(raw);
      return idx === -1 ? CATEGORY_ORDER.length : idx;
    };
    entries.sort((a, b) => {
      const orderDiff = index(a.key) - index(b.key);
      if(orderDiff !== 0) return orderDiff;
      return a.display.localeCompare(b.display, 'ru');
    });
    return entries;
  }

  function renderHomeCategories(){
    if(state.loading){
      return renderStatus('Загружаем каталог...');
    }
    if(state.error){
      return renderStatus(state.error, true);
    }
    const categories = orderedCategories();
    if(!categories.length){
      return renderStatus('Каталог пока пуст. Возвращайтесь позже.');
    }
    return categories.map(category => {
      const heading = escapeHtml(category.display);
      const aria = escapeAttribute(`Открыть каталог категории ${category.display}`);
      const visible = category.items.slice(0, 4);
      const cards = visible.length
        ? visible.map(productCard).join('')
        : `<div class="status-card">В этой категории пока нет товаров.</div>`;
      return `
            <div class="space-v-16">
              <div class="section-header home-category-header">
                <h2 class="category-heading">${heading}</h2>
                <a class="btn-view-all" href="/catalog" data-route="catalog" aria-label="${aria}">Смотреть все</a>
              </div>
              <div class="product-row product-row--home">
                ${cards}
              </div>
            </div>
          `;
    }).join('');
  }

  function productCard(product){
    if(!product) return '';
    const id = String(product.id);
    const nameRaw = product.name || product.title || `Памятник ${id}`;
    const name = escapeHtml(nameRaw);
    const image = productImage(product);
    const rawDescription = product.description ? String(product.description).replace(/\s+/g,' ').trim() : '';
    const description = rawDescription
      ? escapeHtml(rawDescription)
      : 'Описание появится позже.';
    const dataId = escapeAttribute(id);
    const link = productLink(id);
    const routeAttr = escapeAttribute(`product/${encodeURIComponent(String(id))}`);
    const aria = escapeAttribute(`Подробнее о ${nameRaw}`);
    const safeImage = escapeAttribute(image);
    const safeAlt = escapeHtml(nameRaw);
    const imageContent = image
      ? `<img src="${safeImage}" alt="${safeAlt}" loading="lazy">`
      : `<div class="product-image-placeholder" aria-hidden="true"></div>`;
    return `
      <article class="product-tile" data-testid="product-card-${dataId}">
        <a class="product-image-link${image ? ' has-image' : ''}" href="${link}" data-route="${routeAttr}" aria-label="${aria}">
          ${imageContent}
        </a>
        <div class="product-tile-body">
          <div class="product-name">${name}</div>
          <div class="product-price">${priceText(product)}</div>
          <div class="product-tile-description">${description}</div>
        </div>
        <a class="product-tile-more" href="${link}" data-route="${routeAttr}" aria-label="${aria}">Подробнее →</a>
      </article>
    `;
  }

  // ---------------- Views ----------------
  function viewHome(){
    return `
      <section class="hero-section" style="--hero-bg-image:url('../static/images/main.jpg');">
        <!-- Замените URL_ДЛЯ_ФОНА на ссылку на нужное фоновое изображение -->
        <div class="hero-inner">
          <div class="hero-content">
            <h1 class="hero-title">Мы создаём памятники с заботой и уважением</h1>
            <p class="hero-text">Мы сопровождаем семьи на каждом этапе: от выбора материала до установки. Работаем с натуральным гранитом, мрамором и габбро‑диабазом. Бережно относимся к традициям и деталям, чтобы память о близких сохраняла достоинство долгие годы.</p>
            <div class="hero-actions">
              <a class="hero-button" id="cta-home" href="/catalog" data-route="catalog">Перейти в каталог</a>
              <a class="btn-filled" data-action="callback" data-prefill="Интересует памятник">Заказать консультацию</a>
            </div>
          </div>
          <div class="hero-media">
            ${media(null, '/static/images/main.jpg', 'Пример памятника из гранита')}
            <div class="hero-media-note">Примеры наших памятников из натурального камня</div>          
          </div>
        </div>
      </section>
      <section class="materials-section">
        <div class="container">
          <div class="materials-header">
            <h2 class="materials-title">Материалы, из которых мы работаем</h2>
            <div class="materials-accent"></div>
            <p class="materials-description">Используем только натуральный камень высочайшего качества, проверенный временем.</p>
          </div>
          <div class="materials-grid">
            <!-- Замените #материал1, #материал2 и #материал3 на реальные пути к изображениям материалов -->
            ${[
              ["Карельский Габбро-Диабаз","Самый распространенный камень для памятников","../static//images/material_black.png"],
              ["Премиальные виды гранита","Блю Перл(Норвегия), Шокша(Карелия), Хибинит","../static//images/material_blue.png"],
              ["Разнообразные виды камня","Большая палитра цветов для Ваших памятников. Дымовский, Возрождение, Ала-Носкуа, Игл Рэд, Балтик Грин и многие другие","../static//images/material_brown.png"],
            ].map(([name,note,marker])=>`
              <article class="material-card">
                <div class="material-image">
                  <img src="${escapeAttribute(marker)}" alt="${escapeAttribute(name)}" loading="lazy" onerror="this.style.display='none'">
                </div>
                <div class="material-title">${name}</div>
                <p class="material-text">${note}</p>
              </article>
            `).join('')}
          </div>
        </div>
      </section>
      <div class="container section-intro">
        <div class="section-intro-title">Наши работы</div>
        <div class="section-intro-accent"></div>
      </div>
      <section class="section" id="catalog-preview">
        <div class="container">
          ${renderHomeCategories()}
        </div>
      </section>
    `;
  }


  function viewCatalog(){
    let content = '';
    if(state.loading){
      content = renderStatus('Загружаем каталог...');
    }else if(state.error){
      content = renderStatus(state.error, true);
    }else if(!state.products.length){
      content = renderStatus('Каталог пока пуст. Возвращайтесь позже.');
    }else{
      content = `<div class="product-row product-row--catalog">${state.products.map(productCard).join('')}</div>`;
    }
    return `
      <section class="section">
        <div class="container">
          <h2>Каталог памятников</h2>
          ${content}
        </div>
      </section>
    `;
  }

  function viewAbout(){
    return `
      <section class="section">
        <div class="container">
          <div class="grid cols-2 align-center">
            <div>
              <h2>О компании</h2>
              <p>Наша миссия — сохранять память о близких с уважением и тактом. Мы уделяем внимание каждой детали: от выбора камня и разработки эскиза до монтажа и ухода. Используем проверенные материалы и технологии, чтобы памятник на долгие годы сохранял форму и красоту.</p>
              <div class="space-v-16"></div>
              <p class="muted">Мы открыты к диалогу, бережно работаем с пожеланиями семьи и придерживаемся сроков.</p>
            </div>
            <div>${media()}</div>
          </div>
        </div>
      </section>
    `;
  }

  function viewContacts(){
    return `
      <section class="section">
        <div class="container">
          <h2>Свяжитесь с нами</h2>
          <div class="space-v-16"></div>
          <div class="card">
            <div class="row-wrap contact-details">
              <div><strong>Телефон:</strong> <a class="link" href="tel:+74951234567">+7 (495) 123‑45‑67</a></div>
              <div><strong>E‑mail:</strong> <a class="link" href="mailto:info@студия-гранита.рф">info@студия‑гранита.рф</a></div>
              <div><strong>Адрес:</strong> г. Москва, ул. Примерная, 12</div>
              <div><strong>Часы:</strong> Пн–Сб 10:00–18:00</div>
            </div>
            <div class="space-v-16"></div>
            <button class="btn-outline dark-text" data-action="callback">Заказать звонок</button>
          </div>
          <div class="space-v-16"></div>
          <div class="card">
            <div id="ymap" aria-label="Карта (плейсхолдер)"></div>
            <div class="map-note">Интерактивная карта временно отключена. Используется плейсхолдер для прохождения автотестов (#ymap).</div>
          </div>
        </div>
      </section>
    `;
  }
  function viewProduct(id){
    if(state.loading){
      return `
        <section class="section">
          <div class="container">
            ${renderStatus('Загружаем данные о товаре...')}
          </div>
        </section>
      `;
    }
    if(state.error){
      return `
        <section class="section">
          <div class="container">
            ${renderStatus(state.error, true)}
          </div>
        </section>
      `;
    }
    const product = getProductById(id);
    if(!product){
      return `
        <section class="section">
          <div class="container">
            ${renderStatus('Товар не найден или был удалён.')}
            <div class="space-v-16"></div>
            <a class="btn-view-all" href="/catalog" data-route="catalog">Вернуться в каталог</a>
          </div>
        </section>
      `;
    }
    const idValue = String(product.id);
    const nameRaw = product.name || product.title || `Памятник ${idValue}`;
    const name = escapeHtml(nameRaw);
    const categoryName = escapeHtml(displayCategoryName(product.category));
    const price = priceValue(product) || 'по запросу';
    const description = product.description
      ? `<div class="product-description-text">${formatTextBlock(product.description)}</div>`
      : `<div class="product-description-text muted">Описание появится позже.</div>`;
    const image = productImage(product);
    const safeImage = escapeAttribute(image);
    const safeAlt = escapeHtml(nameRaw);
    const callbackPrefill = escapeAttribute(`Интересует ${nameRaw}`);
    const similarItems = similarList(product);
    const similarCards = similarItems.length
      ? `<div class="product-row">${similarItems.map(productCard).join('')}</div>`
      : `<div class="status-card">Пока нет похожих памятников.</div>`;
    return `
      <section class="section">
        <div class="container">
            <a class="back-link" href="/catalog" data-route="catalog">
            <svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M11.707 4.293a1 1 0 0 1 0 1.414L8.414 9H17a1 1 0 1 1 0 2H8.414l3.293 3.293a1 1 0 0 1-1.414 1.414l-5-5a1 1 0 0 1 0-1.414l5-5a1 1 0 0 1 1.414 0Z"/></svg>
            <span>Назад к каталогу</span>
          </a>
          <div class="product-detail">
            <div class="product-main-image${image ? ' has-image' : ''}">
              ${image ? `<img src="${safeImage}" alt="${safeAlt}" loading="lazy">` : ''}
            </div>
              <div class="product-info">
              <div class="product-info-content">
                <span class="product-category-pill">${categoryName}</span>
                <h2 class="product-title">${name}</h2>
                <div class="product-price-amount">${price}</div>
                <div class="product-divider"></div>
                <div>
                  <div class="description-heading">Описание</div>
                  ${description}
                </div>
              </div>
              <button class="callback-button" data-action="callback" data-prefill="${callbackPrefill}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M5.5 3.75h4l1.5 3.75-2.25 1.5a11 11 0 0 0 5.75 5.75l1.5-2.25 3.75 1.5v4a1.5 1.5 0 0 1-1.625 1.5 17.5 17.5 0 0 1-15.125-15.125A1.5 1.5 0 0 1 5.5 3.75Z" />
                </svg>
                <span>Заказать звонок</span>
              </button>
              <div class="product-support-note">Наши специалисты помогут подобрать оптимальный вариант памятника, проконсультируют по материалам и срокам изготовления. Звоните или оставьте заявку на обратный звонок.</div>
            </div>
          </div>
        </div>
        <div class="container space-v-24">
          <div class="similar-header">Похожие памятники</div>
          <div class="similar-accent"></div>
          ${similarCards}
        </div>
      </section>
    `;
  }



  // ---------------- Router ----------------
  function currentRoute(){
    const path = location.pathname.replace(/\/+$/, '') || '/';
    const parts = path.split('/').filter(Boolean);
    const base = parts[0] || '';
    const param = parts.length > 1 ? decodeURIComponent(parts[1]) : '';
    return { base, param };
  }

  function normalizePath(path){
    if(!path) return '/';
    if(path.startsWith('/')) return path || '/';
    return '/' + path.replace(/^\/+/, '');
  }

  function navigateToHref(path){
    const normalized = normalizePath(path);
    if(normalized === location.pathname){
      render();
      return;
    }
    history.pushState({}, '', normalized);
    render();
  }

  function navigateToRoute(route){
    const clean = (route || '').replace(/^\/+|\/+$/g, '');
    navigateToHref(clean ? '/' + clean : '/');
  }

  function handleLinkClick(event){
    const link = event.target.closest('a');
    if(!link) return;
    const href = link.getAttribute('href') || '';
    if(link.target === '_blank' || link.hasAttribute('download')) return;
    if(href.startsWith('http') || href.startsWith('mailto:') || href.startsWith('tel:') || href.startsWith('javascript:')) return;
    const routeAttr = link.getAttribute('data-route');
    if(routeAttr !== null){
      event.preventDefault();
      navigateToRoute(routeAttr);
      return;
    }
    if(href){
      event.preventDefault();
      navigateToHref(href);
    }
  }

  function render(){
    const { base, param } = currentRoute();
    document.title = 'студия-гранита.рф — ' + titleFor(base);
    const app = $('#app');
    let html = '';
    if(base===''){ html = viewHome(); }
    else if(base==='catalog'){ html = viewCatalog(); }
    else if(base==='about'){ html = viewAbout(); }
    else if(base==='contacts'){ html = viewContacts(); }
    else if(base==='product'){ html = viewProduct(param||''); }
    else { html = viewHome(); }
    app.innerHTML = html;
    window.scrollTo({ top: 0, behavior: 'smooth' });
    setActiveNav(base||'');
    wirePageInteractions();
  }

  window.addEventListener('popstate', render);
  document.addEventListener('DOMContentLoaded', ()=>{
    $('#year').textContent = String(new Date().getFullYear());
    document.addEventListener('click', handleLinkClick);
    render();
    loadProducts();
    maybeRunTests();
  });
  // ---------------- Data loading ----------------
  async function loadProducts(){
    setState({ loading: true, error: null });
    try{
      const response = await fetch('/api/products');
      if(!response.ok){
        throw new Error('Не удалось получить список товаров');
      }
      const payload = await response.json();
      const items = Array.isArray(payload?.items) ? payload.items : [];
      const normalized = items.map(normalizeProduct);
      setState({ products: normalized, loading: false, error: null });
    }catch(error){
      console.error('Ошибка загрузки каталога', error);
      setState({ products: [], loading: false, error: 'Не удалось загрузить каталог. Попробуйте обновить страницу позже.' });
    }
  }

  // ---------------- Interactions ----------------
  function wirePageInteractions(){
    // Modal open triggers
    $all('[data-action="callback"]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const pre = btn.getAttribute('data-prefill') || '';
        const text = pre ? ('Интересует памятник ' + pre.replace(/^Интересует\s*/,'')) : '';
        openModal(text);
      });
    });
  }

  function openModal(prefillComment=''){
    const bd = $('#modal-backdrop');
    $('#success').style.display = 'none';
    $('#callback-form').reset();
    if(prefillComment) $('#comment').value = prefillComment;
    bd.style.display = 'flex';
    bd.setAttribute('aria-hidden','false');
    $('#name').focus();
  }
  function closeModal(){
    const bd = $('#modal-backdrop');
    bd.style.display = 'none';
    bd.setAttribute('aria-hidden','true');
  }

  function normalizeDigits(v){ return v.replace(/\D/g,''); }
  function formatPhone(d){
    if(!d) return '';
    if(d[0]==='8') d='7'+d.slice(1);
    if(d[0]!=='7') d='7'+d;
    d = d.slice(0,11);
    let out = '+7 ';
    if(d.length>1){ out += '(' + d.slice(1,4); if(d.length>=4) out += ') '; }
    if(d.length>=7){ out += d.slice(4,7) + '-' + d.slice(7,9) + '-' + d.slice(9,11); }
    else if(d.length>4){ out += d.slice(4); }
    return out.trim();
  }

  $('#close-btn').addEventListener('click', closeModal);
  $('#modal-backdrop').addEventListener('click', (e)=>{
    if(e.target.id==='modal-backdrop') closeModal();
  });

  // Phone masking
  const phoneEl = $('#phone');
  phoneEl.addEventListener('input', ()=>{
    const digits = normalizeDigits(phoneEl.value);
    phoneEl.value = formatPhone(digits);
  });
  phoneEl.addEventListener('focus', ()=>{
    if(!phoneEl.value) phoneEl.value = '+7 (';
  });

  // Form validation + success
  $('#callback-form').addEventListener('submit', (e)=>{
    e.preventDefault();
    const name = $('#name').value.trim();
    const digits = normalizeDigits($('#phone').value);
    let ok = true;
    if(name.length<2){ ok=false; $('#err-name').style.display='block'; } else { $('#err-name').style.display='none'; }
    if(!(digits.length===11 && digits[0]==='7')){ ok=false; $('#err-phone').style.display='block'; } else { $('#err-phone').style.display='none'; }
    if(!ok) return;
    // Simulate submit
    const btn = $('#submit-btn'); btn.disabled = true; btn.textContent = 'Отправка...';
    setTimeout(()=>{
      btn.disabled = false; btn.textContent = 'Отправить';
      $('#success').style.display = 'block';
      setTimeout(()=>{ closeModal(); }, 1200);
    }, 700);
  });

  // ---------------- Tests (run with ?test=1) ----------------
  function expect(cond, msg){ if(!cond) throw new Error(msg); }
  function textIncludes(sel, substr){ const el = document.querySelector(sel); return !!el && !!el.textContent && el.textContent.includes(substr); }
  function count(sel){ return document.querySelectorAll(sel).length; }
  function navigate(path){ navigateToHref(path); }

  
  let testsScheduled = false;
  function maybeRunTests(){
    const params = new URLSearchParams(location.search);
    if(params.get('test')==='1' && !testsScheduled){
      testsScheduled = true;
      const waitForData = () => {
        if(state.loading){
          setTimeout(waitForData, 100);
          return;
        }
        setTimeout(runTests, 50);
      };
      waitForData();
    }
  }

  function runTests(){
    const prev = location.pathname;
    console.group('%cUI tests','color:gray');
    try{
      navigate('/');
      expect(textIncludes('h1','Мы создаём памятники'), 'Home: заголовок не найден');
      expect(count('#cta-home')===1, 'Home: основной CTA должен быть один');

      navigate('/catalog');
      if(state.products.length){
        expect(count('[data-testid^="product-card-"]')===state.products.length, 'Catalog: кол-во карточек не совпало');
        const firstProduct = state.products[0];
        navigate(`/product/${encodeURIComponent(firstProduct.id)}`);
        expect(textIncludes('h2', firstProduct.name || firstProduct.title || ''), 'Product: заголовок не совпал');
        expect(textIncludes('section .container','Цена:'), 'Product: цена не отображается');
        expect(count('.media')>=1, 'Product: изображения не отображаются');
      }else{
        expect(count('[data-testid^="product-card-"]')===0, 'Catalog: каталог должен быть пустым');
      }

      navigate('/about');
      expect(textIncludes('h2','О компании'), 'About: заголовок не найден');

      navigate('/contacts');
      expect(document.getElementById('ymap')!==null, 'Contacts: контейнер карты отсутствует');
      expect(textIncludes('.card','Заказать звонок'), 'Contacts: кнопка не найдена');

      console.log('%c✔ Все тесты пройдены','color:green');
    }catch(e){
      console.error('✘ Тест упал:', e.message);
    }finally{
      history.replaceState({}, '', prev || '/');
      render();
      console.groupEnd();
    }
  }
  </script>
</body>
</html>
